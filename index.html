<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'unsafe-inline'; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src https://fonts.gstatic.com; img-src 'self' data:; media-src 'self' https://translate.google.com; connect-src https://translate.google.com;" />
  <meta http-equiv="Permissions-Policy" content="camera=(), microphone=(), geolocation=(), payment=()" />
  <title>ã‚­ãƒƒã‚º ã‚²ãƒ¼ãƒ </title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;700;900&display=swap">
  <style>
    :root{--bg:#fff7fb;--ink:#222;--muted:#888;--accent:#ff4d6d;--ok:#22c55e;--ng:#f59e0b;--shadow:0 8px 30px rgba(0,0,0,.08);--radius:20px;}
    *{box-sizing:border-box;-webkit-tap-highlight-color:transparent;margin:0;padding:0;}
    body{font-family:'Zen Maru Gothic',system-ui,-apple-system,"Hiragino Sans","Noto Sans JP",sans-serif;background:radial-gradient(circle at 20% 10%,#ffe3ef,transparent 45%),radial-gradient(circle at 80% 0%,#e7f3ff,transparent 45%),var(--bg);color:var(--ink);min-height:100dvh;}
    .wrap{max-width:880px;margin:0 auto;padding:16px 14px 32px;}
    .btn{border:0;border-radius:14px;padding:12px 18px;font-weight:800;font-size:15px;background:#f2f2f7;color:#1c1c1e;cursor:pointer;transition:transform .1s;}
    .btn:active{transform:scale(.96);}
    .btn.accent{background:var(--accent);color:#fff;font-size:22px;padding:20px 48px;border-radius:999px;box-shadow:0 6px 24px rgba(255,77,109,.3);}
    .screen{display:none;flex-direction:column;align-items:center;justify-content:center;gap:20px;min-height:auto;text-align:center;animation:fadeIn .3s;}
    .screen.active{display:flex;}
    @keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:none}}

    /* ãƒ¡ãƒ‹ãƒ¥ãƒ¼ */
    .menu-title{font-size:36px;font-weight:900;}
    .menu-sub{font-size:16px;color:var(--muted);line-height:1.7;}
    .game-cards{display:flex;gap:20px;flex-wrap:wrap;justify-content:center;margin-top:10px;}
    .game-card{background:#fff;border-radius:24px;box-shadow:0 10px 40px rgba(0,0,0,.10);padding:28px 24px;width:260px;cursor:pointer;transition:transform .15s,box-shadow .15s;display:flex;flex-direction:column;align-items:center;gap:14px;border:3px solid transparent;}
    .game-card:hover{transform:translateY(-4px);box-shadow:0 16px 50px rgba(0,0,0,.15);border-color:var(--accent);}
    .game-card:active{transform:scale(.97);}
    .game-card .card-icon{font-size:64px;}
    .game-card .card-title{font-size:22px;font-weight:900;}
    .game-card .card-desc{font-size:14px;color:var(--muted);line-height:1.6;}

    /* ======== Game1 ======== */
    .btn.lv{min-width:64px;}.btn.lv.active{background:var(--accent);color:#fff;}
    .start-title{font-size:32px;font-weight:900;}
    .start-sub{font-size:14px;color:var(--muted);line-height:1.7;}
    .level-select{display:flex;gap:10px;align-items:center;background:rgba(255,255,255,.7);padding:10px;border-radius:16px;box-shadow:var(--shadow);}
    .rounds-select{display:flex;gap:10px;align-items:center;background:rgba(255,255,255,.7);padding:10px;border-radius:16px;box-shadow:var(--shadow);}
    .btn.rd{min-width:64px;}.btn.rd.active{background:#118ab2;color:#fff;}
    .animal-toggle-btn{font-size:13px;color:var(--muted);background:none;border:1px dashed #ccc;border-radius:12px;padding:8px 16px;cursor:pointer;}
    .animal-select-wrap{display:none;flex-direction:column;align-items:center;gap:10px;width:100%;}
    .animal-select-wrap.open{display:flex;}
    .animal-select{display:flex;flex-wrap:wrap;gap:8px;justify-content:center;max-width:600px;}
    .animal-chip{display:flex;align-items:center;gap:6px;padding:6px 12px 6px 6px;border-radius:12px;border:2px solid #e0e0e0;background:#fff;cursor:pointer;transition:all .15s;font-size:14px;font-weight:700;}
    .animal-chip.selected{border-color:var(--accent);background:#fff0f3;}
    .animal-chip .chip-icon{width:36px;height:36px;border-radius:8px;overflow:hidden;display:flex;align-items:center;justify-content:center;}
    .animal-chip .chip-icon img{width:100%;height:100%;object-fit:contain;}
    #g1GameScreen{gap:14px;}
    .game-header{display:flex;justify-content:space-between;align-items:center;width:100%;padding:0 4px;flex-wrap:wrap;gap:6px;}
    .badge{font-weight:900;background:#fff;padding:8px 14px;border-radius:999px;box-shadow:0 4px 14px rgba(0,0,0,.07);font-size:14px;white-space:nowrap;}
    .streak-msg{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);font-size:36px;font-weight:900;color:var(--accent);pointer-events:none;opacity:0;transition:all .4s;z-index:100;text-shadow:0 4px 20px rgba(255,77,109,.3);}
    .streak-msg.show{opacity:1;transform:translate(-50%,-60%);}
    .game-main{display:flex;flex-direction:column;gap:14px;width:100%;}
    .prompt-card{background:rgba(255,255,255,.85);border-radius:var(--radius);box-shadow:var(--shadow);padding:20px;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:12px;min-height:280px;position:relative;overflow:hidden;}
    .prompt-label{font-size:18px;font-weight:900;background:#fff;padding:8px 16px;border-radius:999px;box-shadow:0 4px 14px rgba(0,0,0,.06);}
    .big-icon{width:200px;height:200px;display:flex;align-items:center;justify-content:center;border-radius:24px;background:rgba(255,255,255,.9);box-shadow:inset 0 0 0 2px rgba(0,0,0,.05),var(--shadow);overflow:hidden;transition:filter .5s,transform .4s;}
    .big-icon img{width:100%;height:100%;object-fit:contain;}
    .big-icon.bounce{animation:bounceAnim .6s ease;}
    .big-icon.megaBounce{animation:megaBounce .8s ease;}
    @keyframes bounceAnim{0%{transform:scale(1)}30%{transform:scale(1.25) rotate(-5deg)}50%{transform:scale(1.15) rotate(3deg)}70%{transform:scale(1.2) rotate(-2deg)}100%{transform:scale(1)}}
    @keyframes megaBounce{0%{transform:scale(1)}20%{transform:scale(1.4) rotate(-8deg)}40%{transform:scale(1.3) rotate(6deg)}60%{transform:scale(1.35) rotate(-4deg)}80%{transform:scale(1.3) rotate(2deg)}100%{transform:scale(1)}}
    .hint-text{font-size:14px;color:var(--muted);text-align:center;}
    .cry-btn{background:var(--accent);color:#fff;border:none;border-radius:999px;padding:8px 18px;font-weight:800;font-size:14px;cursor:pointer;box-shadow:0 4px 12px rgba(255,77,109,.2);}
    .cry-btn:active{transform:scale(.95);}
    .feedback-overlay{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:8px;pointer-events:none;opacity:0;transform:scale(.9);transition:all .25s;}
    .feedback-overlay.show{opacity:1;transform:scale(1);}
    .fb-circle{width:140px;height:140px;border-radius:999px;display:flex;align-items:center;justify-content:center;font-size:60px;font-weight:900;color:#fff;}
    .fb-ok{background:var(--ok);box-shadow:0 10px 40px rgba(34,197,94,.3);}
    .fb-ng{background:var(--ng);box-shadow:0 10px 40px rgba(245,158,11,.3);}
    .fb-label{font-size:22px;font-weight:900;color:#fff;text-shadow:0 2px 8px rgba(0,0,0,.2);}
    .correct-reveal{font-size:16px;font-weight:800;color:var(--ok);opacity:0;transition:opacity .3s;text-align:center;}
    .correct-reveal.show{opacity:1;}
    .choices-card{background:rgba(255,255,255,.85);border-radius:var(--radius);box-shadow:var(--shadow);padding:14px;display:flex;flex-direction:column;gap:10px;}
    .choices-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
    .choice{display:flex;align-items:center;gap:12px;width:100%;border:3px solid transparent;cursor:pointer;padding:14px;border-radius:18px;background:#fff;box-shadow:0 6px 20px rgba(0,0,0,.06);transition:transform .08s,border-color .2s;text-align:left;min-height:90px;}
    .choice:active{transform:scale(.97);}
    .choice.correct{border-color:var(--ok);background:#f0fdf4;}
    .choice.wrong{border-color:var(--ng);background:#fffbeb;opacity:.7;}
    .choice .mini{width:64px;height:64px;border-radius:14px;background:#f7f7fb;display:flex;align-items:center;justify-content:center;overflow:hidden;flex:0 0 auto;transition:filter .5s;}
    .choice .mini img{width:100%;height:100%;object-fit:contain;}
    .choice .c-label{font-size:24px;font-weight:900;letter-spacing:.02em;}
    .choice .sound-btn{margin-left:auto;background:none;border:none;font-size:24px;cursor:pointer;padding:4px 8px;flex:0 0 auto;}
    .result-card{background:#fff;border-radius:var(--radius);box-shadow:var(--shadow);padding:32px;text-align:center;max-width:400px;width:100%;}
    .result-medal{font-size:80px;margin-bottom:8px;}
    .result-score{font-size:48px;font-weight:900;color:var(--accent);}
    .result-sub{font-size:18px;color:var(--muted);margin:8px 0 20px;}
    .result-detail{font-size:14px;color:var(--muted);margin-bottom:20px;line-height:1.8;white-space:pre-line;}
    .result-stars{font-size:32px;letter-spacing:4px;margin-bottom:16px;}
    .result-btns{display:flex;gap:12px;justify-content:center;flex-wrap:wrap;}
    canvas#confetti{position:fixed;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:200;}
    /* ãšã‹ã‚“ */
    .zukan-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:14px;width:100%;max-width:600px;}
    .zukan-item{background:#fff;border-radius:18px;box-shadow:0 4px 16px rgba(0,0,0,.08);padding:14px;display:flex;flex-direction:column;align-items:center;gap:8px;cursor:pointer;transition:transform .1s;}
    .zukan-item:active{transform:scale(.96);}
    .zukan-item img{width:80px;height:80px;object-fit:contain;}
    .zukan-item .z-name{font-size:18px;font-weight:900;}
    .zukan-item .z-fact{font-size:11px;color:var(--muted);line-height:1.5;}

    /* ======== Game2 ======== */
    .g2-wrap{width:100%;max-width:980px;}
    .g2-header{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;}
    .g2-subtitle{margin:0;color:var(--muted);font-size:13px;}
    .g2-pill{display:flex;gap:8px;align-items:center;background:rgba(255,255,255,.7);border:1px solid rgba(0,0,0,.06);padding:8px 10px;border-radius:999px;box-shadow:0 6px 16px rgba(0,0,0,.05);user-select:none;}
    .g2-pill strong{font-size:14px;}.g2-pill small{color:var(--muted);}
    .g2-iconBtn{border:1px solid rgba(0,0,0,.08);background:rgba(255,255,255,.75);border-radius:999px;padding:10px 12px;cursor:pointer;box-shadow:0 10px 20px rgba(0,0,0,.06);font-weight:900;}
    .g2-iconBtn:active{transform:translateY(1px);}
    .g2-panel{background:#fff;border-radius:var(--radius);box-shadow:var(--shadow);border:1px solid rgba(0,0,0,.06);overflow:hidden;width:100%;}
    .g2-scene{padding:14px;display:flex;flex-direction:column;gap:12px;}
    .g2-prompt{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;}
    .g2-prompt .q{font-size:clamp(18px,3vw,26px);margin:0;font-weight:900;}
    .g2-prompt .hint{margin:0;color:var(--muted);font-size:13px;display:flex;gap:8px;align-items:center;flex-wrap:wrap;justify-content:flex-end;}
    .lane{position:relative;height:min(42vh,320px);min-height:220px;border-radius:16px;background:radial-gradient(1200px 220px at 50% 0%,rgba(37,99,235,.15),transparent 55%),linear-gradient(180deg,#fefefe,#f5f7ff);border:1px solid rgba(0,0,0,.06);overflow:hidden;}
    .ground{position:absolute;left:0;right:0;bottom:0;height:40%;background:linear-gradient(180deg,rgba(34,197,94,.18),rgba(34,197,94,.28));}
    .track{position:absolute;left:0;right:0;bottom:22%;height:10px;background:rgba(0,0,0,.08);}
    .track::before,.track::after{content:"";position:absolute;left:0;right:0;height:2px;background:rgba(0,0,0,.18);}
    .track::before{top:1px;}.track::after{bottom:1px;}
    .cloud{position:absolute;top:14%;width:120px;height:44px;background:rgba(255,255,255,.75);border:1px solid rgba(0,0,0,.06);border-radius:999px;animation:float 10s linear infinite;}
    .cloud::before,.cloud::after{content:"";position:absolute;background:rgba(255,255,255,.75);border:1px solid rgba(0,0,0,.06);border-radius:999px;}
    .cloud::before{width:50px;height:50px;left:14px;top:-18px;}.cloud::after{width:70px;height:70px;left:48px;top:-34px;}
    @keyframes float{0%{transform:translateX(-160px)}100%{transform:translateX(calc(100% + 160px))}}
    .train{position:absolute;bottom:26%;left:0;display:flex;gap:6px;align-items:flex-end;will-change:transform;transform:translateX(-30%);}
    .engine,.car{width:clamp(60px,12vw,80px);height:clamp(56px,11vw,74px);border-radius:14px;background:#fff;border:1px solid rgba(0,0,0,.08);box-shadow:0 6px 14px rgba(0,0,0,.10);position:relative;display:flex;align-items:center;justify-content:center;user-select:none;}
    .engine{background:linear-gradient(180deg,var(--train-c1,rgba(37,99,235,.18)),var(--train-c2,rgba(37,99,235,.06)));}
    .engine .label{position:absolute;top:4px;left:6px;font-size:10px;color:var(--train-label,rgba(37,99,235,.85));font-weight:900;letter-spacing:.02em;}
    .wheel{position:absolute;bottom:-8px;width:16px;height:16px;border-radius:50%;background:rgba(0,0,0,.75);box-shadow:inset 0 0 0 2px rgba(255,255,255,.16);}
    .wheel.w1{left:8px;}.wheel.w2{left:30px;}.wheel.w3{right:8px;}
    .animal{width:clamp(36px,9vw,50px);height:clamp(36px,9vw,50px);cursor:pointer;filter:drop-shadow(0 4px 4px rgba(0,0,0,.10));transform:translateY(-2px);border-radius:8px;overflow:hidden;}
    .animal img{width:100%;height:100%;object-fit:contain;}
    .animal.tap{animation:pop .18s ease-out;}
    @keyframes pop{0%{transform:translateY(-2px) scale(1)}60%{transform:translateY(-4px) scale(1.12)}100%{transform:translateY(-2px) scale(1)}}
    .station{position:absolute;right:16px;bottom:23%;width:134px;height:148px;border-radius:18px;background:rgba(255,255,255,.72);border:1px solid rgba(0,0,0,.07);box-shadow:0 12px 24px rgba(0,0,0,.08);display:flex;align-items:center;justify-content:center;text-align:center;padding:10px;color:var(--muted);font-weight:900;}
    .station span{display:block;font-size:12px;}.station strong{display:block;font-size:14px;color:var(--ink);margin-top:4px;}
    .g2-answers{padding:12px 12px 14px;display:grid;grid-template-columns:repeat(5,1fr);gap:8px;}
    .g2-btn{border:0;border-radius:14px;padding:10px 6px;font-size:clamp(18px,3.5vw,26px);font-weight:900;background:rgba(37,99,235,.10);color:var(--ink);box-shadow:0 6px 16px rgba(0,0,0,.08);border:1px solid rgba(37,99,235,.18);cursor:pointer;user-select:none;}
    .g2-btn:active{transform:translateY(1px);}.g2-btn[disabled]{opacity:.55;cursor:not-allowed;}
    .g2-footerRow{padding:12px;display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between;border-top:1px solid rgba(0,0,0,.06);background:rgba(249,250,251,.7);}
    .g2-progress{display:flex;align-items:center;gap:10px;flex:1;min-width:240px;}
    .g2-bar{height:12px;flex:1;border-radius:999px;background:rgba(0,0,0,.08);overflow:hidden;border:1px solid rgba(0,0,0,.06);}
    .g2-bar>i{display:block;height:100%;width:0%;background:rgba(22,163,74,.75);}
    .g2-mini{display:flex;gap:8px;align-items:center;justify-content:flex-end;min-width:240px;flex-wrap:wrap;}
    .g2-smallBtn{border:1px solid rgba(0,0,0,.08);background:rgba(255,255,255,.75);padding:10px 12px;border-radius:14px;font-weight:900;cursor:pointer;box-shadow:0 10px 20px rgba(0,0,0,.06);white-space:nowrap;}
    .g2-smallBtn:active{transform:translateY(1px);}
    .g2-book{padding:12px 12px 14px;border-top:1px solid rgba(0,0,0,.06);background:rgba(255,255,255,.55);display:flex;flex-direction:column;gap:10px;}
    .g2-bookTop{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;}
    .g2-bookTitle{font-weight:900;display:flex;align-items:center;gap:8px;}
    .g2-animalShelf{display:flex;gap:8px;flex-wrap:wrap;align-items:center;}
    .g2-chip{padding:6px 10px;border-radius:999px;background:rgba(37,99,235,.08);border:1px solid rgba(0,0,0,.06);font-weight:900;color:var(--muted);display:inline-flex;align-items:center;gap:4px;}
    .g2-chip img{width:22px;height:22px;object-fit:contain;}
    .g2-stickers{display:grid;grid-template-columns:repeat(10,1fr);gap:8px;}
    .g2-slot{height:34px;border-radius:10px;border:1px dashed rgba(0,0,0,.16);background:rgba(255,255,255,.55);display:flex;align-items:center;justify-content:center;font-size:18px;user-select:none;}
    .g2-toast{position:fixed;left:50%;bottom:18px;transform:translateX(-50%);background:rgba(17,24,39,.92);color:#fff;padding:10px 14px;border-radius:999px;font-weight:900;box-shadow:0 14px 30px rgba(0,0,0,.18);opacity:0;pointer-events:none;transition:opacity .18s ease;max-width:min(92vw,520px);text-align:center;z-index:80;}
    .g2-toast.show{opacity:1;}
    .g2-confetti{position:fixed;inset:0;pointer-events:none;z-index:90;overflow:hidden;}
    .g2-confetti i{position:absolute;top:-10px;width:10px;height:14px;border-radius:3px;opacity:.9;animation:g2fall 950ms linear forwards;}
    @keyframes g2fall{to{transform:translateY(calc(100vh + 30px)) rotate(540deg);opacity:.95;}}
    .g2-modalBg{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center;padding:14px;z-index:100;}
    .g2-modalBg.show{display:flex;}
    .g2-modal{width:min(620px,96vw);background:rgba(255,255,255,.96);border:1px solid rgba(0,0,0,.08);border-radius:18px;box-shadow:0 20px 60px rgba(0,0,0,.22);overflow:hidden;}
    .g2-modalHeader{padding:12px 14px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid rgba(0,0,0,.06);font-weight:900;}
    .g2-modalBody{padding:14px;display:flex;flex-direction:column;gap:12px;}
    .g2-row{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;padding:10px 12px;border:1px solid rgba(0,0,0,.06);background:rgba(249,250,251,.7);border-radius:14px;}
    .g2-row label{font-weight:900;}.g2-row small{color:var(--muted);display:block;margin-top:2px;}
    .g2-modalFooter{padding:12px 14px;display:flex;gap:10px;justify-content:flex-end;border-top:1px solid rgba(0,0,0,.06);background:rgba(249,250,251,.7);}

    /* ======== Game3 ======== */
    .g3-wrap{width:100%;max-width:500px;display:flex;flex-direction:column;align-items:center;gap:16px;}
    .g3-modeRow{display:flex;gap:8px;flex-wrap:wrap;justify-content:center;}
    .g3-modeBtn{padding:8px 16px;border-radius:50px;border:3px solid var(--accent);font-family:'Zen Maru Gothic',sans-serif;font-size:14px;font-weight:700;cursor:pointer;transition:all .2s;background:#fff;color:var(--accent);}
    .g3-modeBtn.active{background:var(--accent);color:#fff;transform:scale(1.05);box-shadow:0 4px 12px rgba(255,77,109,.3);}
    .g3-charRow{display:flex;gap:8px;justify-content:center;flex-wrap:wrap;}
    .g3-charBtn{padding:6px 14px;border-radius:50px;border:2px solid #4ecdc4;font-size:13px;font-weight:700;cursor:pointer;background:#fff;color:#4ecdc4;}
    .g3-charBtn.active{background:#4ecdc4;color:#fff;}
    .g3-card{width:min(340px,90vw);background:#fff;border-radius:32px;padding:32px 24px 28px;box-shadow:0 8px 30px rgba(0,0,0,.12);display:flex;flex-direction:column;align-items:center;gap:12px;cursor:pointer;transition:transform .15s;animation:fadeIn .3s;position:relative;overflow:hidden;}
    .g3-card:active{transform:scale(.97);}
    .g3-emoji{font-size:72px;line-height:1;animation:g3bounce 2s ease-in-out infinite;}
    @keyframes g3bounce{0%,100%{transform:translateY(0)}50%{transform:translateY(-8px)}}
    .g3-hira{font-size:96px;font-weight:900;line-height:1;color:#333;font-family:'Zen Maru Gothic',sans-serif;text-shadow:3px 3px 0 rgba(0,0,0,.06);}
    .g3-romaji{font-size:28px;font-weight:700;color:#999;text-transform:uppercase;letter-spacing:3px;}
    .g3-word{font-size:20px;font-weight:700;color:#555;background:#f5f5f5;padding:6px 16px;border-radius:50px;}
    .g3-rateBadge{font-size:12px;font-weight:700;color:#fff;background:var(--ok);padding:3px 10px;border-radius:999px;}
    .g3-tapHint{font-size:13px;color:#ccc;}
    .g3-navRow{display:flex;align-items:center;gap:20px;}
    .g3-navBtn{width:56px;height:56px;border-radius:50%;border:none;font-size:24px;cursor:pointer;transition:all .15s;display:flex;align-items:center;justify-content:center;box-shadow:0 4px 12px rgba(0,0,0,.15);}
    .g3-navBtn:active{transform:scale(.9);}
    .g3-navPrev{background:#ffd93d;}.g3-navNext{background:#6bcb77;}
    .g3-traceBtn{background:#9b5de5;color:#fff;border:none;border-radius:999px;padding:10px 20px;font-weight:800;font-size:14px;cursor:pointer;box-shadow:0 4px 12px rgba(155,93,229,.3);}
    .g3-progInfo{font-size:18px;font-weight:700;color:#666;min-width:60px;text-align:center;}
    .g3-dots{display:flex;gap:6px;flex-wrap:wrap;justify-content:center;max-width:340px;}
    .g3-dot{width:10px;height:10px;border-radius:50%;background:#e0e0e0;transition:all .3s;}
    .g3-dot.seen{background:#4ecdc4;}.g3-dot.current{background:var(--accent);transform:scale(1.4);}
    .g3-quizWrap{display:flex;flex-direction:column;align-items:center;gap:20px;width:100%;}
    .g3-scoreBadge{background:linear-gradient(135deg,#ffd93d,#ff9a3c);border-radius:50px;padding:8px 24px;font-size:18px;font-weight:700;color:#fff;box-shadow:0 4px 12px rgba(255,154,60,.4);}
    .g3-question{font-size:80px;font-weight:900;font-family:'Zen Maru Gothic',sans-serif;background:#fff;border-radius:28px;width:min(200px,55vw);height:min(200px,55vw);display:flex;align-items:center;justify-content:center;box-shadow:0 8px 24px rgba(0,0,0,.1);animation:fadeIn .3s;}
    .g3-instruction{font-size:18px;font-weight:700;color:#666;text-align:center;}
    .g3-options{display:grid;grid-template-columns:1fr 1fr;gap:14px;width:min(340px,90vw);}
    .g3-opt{background:#fff;border:4px solid transparent;border-radius:24px;font-size:52px;font-weight:900;font-family:'Zen Maru Gothic',sans-serif;height:100px;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all .15s;box-shadow:0 4px 16px rgba(0,0,0,.08);}
    .g3-opt:active{transform:scale(.95);}
    .g3-opt.correct{background:#6bcb77;border-color:#6bcb77;color:#fff;animation:g3pop .4s cubic-bezier(.34,1.56,.64,1);}
    .g3-opt.wrong{background:var(--accent);border-color:var(--accent);color:#fff;animation:g3shake .4s ease;}
    @keyframes g3pop{0%{transform:scale(1)}50%{transform:scale(1.15)}100%{transform:scale(1)}}
    @keyframes g3shake{0%,100%{transform:translateX(0)}20%{transform:translateX(-6px)}40%{transform:translateX(6px)}60%{transform:translateX(-4px)}80%{transform:translateX(4px)}}
    .g3-celeb{position:fixed;inset:0;pointer-events:none;z-index:100;display:flex;align-items:center;justify-content:center;}
    .g3-celebText{font-size:64px;font-weight:900;animation:g3celebPop 1s cubic-bezier(.34,1.56,.64,1) forwards;opacity:0;filter:drop-shadow(0 4px 12px rgba(0,0,0,.2));}
    @keyframes g3celebPop{0%{transform:scale(0);opacity:0}40%{transform:scale(1.3);opacity:1}70%{transform:scale(.95);opacity:1}85%{transform:scale(1.05);opacity:1}100%{transform:scale(1);opacity:0}}
    /* ã“ã¨ã°ã¥ãã‚Š */
    .g3-wordGame{display:flex;flex-direction:column;align-items:center;gap:16px;width:100%;}
    .g3-wordTarget{display:flex;gap:8px;justify-content:center;min-height:64px;}
    .g3-wordSlot{width:56px;height:56px;border:3px dashed #ccc;border-radius:16px;display:flex;align-items:center;justify-content:center;font-size:36px;font-weight:900;font-family:'Zen Maru Gothic',sans-serif;background:#fff;transition:all .2s;}
    .g3-wordSlot.filled{border-color:var(--accent);background:#fff0f3;}
    .g3-wordSlot.ok{border-color:var(--ok);background:#f0fdf4;}
    .g3-wordSlot.ng{border-color:var(--ng);}
    .g3-wordPieces{display:flex;gap:10px;justify-content:center;flex-wrap:wrap;}
    .g3-piece{width:56px;height:56px;border-radius:16px;background:#fff;border:3px solid #4ecdc4;display:flex;align-items:center;justify-content:center;font-size:36px;font-weight:900;font-family:'Zen Maru Gothic',sans-serif;cursor:pointer;box-shadow:0 4px 12px rgba(0,0,0,.1);transition:all .15s;}
    .g3-piece:active{transform:scale(.92);}
    .g3-piece.used{opacity:.3;pointer-events:none;}
    /* ãªãã‚ŠãŒã */
    .g3-traceOverlay{position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:150;display:none;align-items:center;justify-content:center;flex-direction:column;gap:12px;}
    .g3-traceOverlay.show{display:flex;}
    .g3-traceCanvas{background:#fff;border-radius:24px;box-shadow:0 10px 40px rgba(0,0,0,.2);touch-action:none;}
    .g3-traceClose{background:#fff;border:none;border-radius:999px;padding:10px 24px;font-weight:900;font-size:16px;cursor:pointer;box-shadow:0 4px 14px rgba(0,0,0,.1);}
    /* ã›ã„ã›ãã²ã‚‡ã† */
    .g3-statsWrap{display:flex;flex-direction:column;align-items:center;gap:12px;width:100%;}
    .g3-statsGrid{display:grid;grid-template-columns:repeat(auto-fill,minmax(50px,1fr));gap:6px;width:min(400px,90vw);}
    .g3-statCell{background:#fff;border-radius:10px;padding:6px;text-align:center;box-shadow:0 2px 8px rgba(0,0,0,.06);font-family:'Zen Maru Gothic',sans-serif;}
    .g3-statCell .ch{font-size:22px;font-weight:900;}
    .g3-statCell .rt{font-size:10px;color:var(--muted);}

    /* æˆ»ã‚‹ãƒœã‚¿ãƒ³ */
    .back-btn{position:fixed;top:14px;left:14px;z-index:50;background:rgba(255,255,255,.85);border:1px solid rgba(0,0,0,.1);border-radius:999px;padding:8px 16px;font-weight:900;font-size:14px;cursor:pointer;box-shadow:0 4px 14px rgba(0,0,0,.08);display:none;}
    .back-btn.visible{display:block;}

    @media(max-width:600px){
      .choices-grid{gap:10px;}
      .choice{padding:16px 12px;min-height:80px;}
      .choice .mini{width:56px;height:56px;}
      .choice .c-label{font-size:22px;}
      .big-icon{width:180px;height:180px;}
      .prompt-card{min-height:240px;padding:16px;}
      .start-title{font-size:26px;}
      .btn.accent{font-size:20px;padding:18px 40px;}
      .game-cards{flex-direction:column;align-items:center;}
      .game-card{width:100%;max-width:340px;}
      .station{display:none;}
      .g2-mini{min-width:unset;width:100%;justify-content:space-between;}
      .g2-progress{width:100%;}
      .g2-stickers{grid-template-columns:repeat(5,1fr);}
    }

    /* ======== Game4: ãªãã”ãˆã‚ã¦ã‚²ãƒ¼ãƒ  ======== */
    .g4-wrap{width:100%;max-width:480px;display:flex;flex-direction:column;align-items:center;gap:18px;}
    .g4-speaker{font-size:48px;background:#fff;border:none;border-radius:50%;width:100px;height:100px;display:flex;align-items:center;justify-content:center;box-shadow:0 6px 24px rgba(0,0,0,.12);cursor:pointer;transition:transform .1s;}
    .g4-speaker:active{transform:scale(.93);}
    .g4-speaker.playing{animation:g4pulse .6s ease-in-out infinite alternate;}
    @keyframes g4pulse{from{box-shadow:0 6px 24px rgba(255,77,109,.2);}to{box-shadow:0 6px 40px rgba(255,77,109,.5);transform:scale(1.06);}}
    .g4-grid{display:grid;grid-template-columns:1fr 1fr;gap:14px;width:100%;}
    .g4-choice{background:#fff;border:3px solid transparent;border-radius:20px;padding:16px 10px;display:flex;flex-direction:column;align-items:center;gap:8px;cursor:pointer;box-shadow:0 6px 20px rgba(0,0,0,.07);transition:transform .1s,border-color .2s;font-weight:900;font-size:18px;}
    .g4-choice:active{transform:scale(.96);}
    .g4-choice img{width:80px;height:80px;object-fit:contain;}
    .g4-choice.correct{border-color:var(--ok);background:#f0fdf4;}
    .g4-choice.wrong{border-color:var(--ng);background:#fffbeb;opacity:.7;}
    /* ======== Game5: ã‚ãã‚Šã‚ã‚ã› ======== */
    .g5-wrap{width:100%;max-width:560px;display:flex;flex-direction:column;align-items:center;gap:16px;}
    .g5-grid{display:grid;gap:10px;width:100%;grid-template-columns:repeat(4,1fr);}
    .g5-card{perspective:400px;cursor:pointer;}
    .g5-inner{position:relative;width:100%;padding-top:100%;transform-style:preserve-3d;transition:transform .4s;}
    .g5-card.flipped .g5-inner{transform:rotateY(180deg);}
    .g5-front,.g5-back{position:absolute;inset:0;border-radius:16px;display:flex;align-items:center;justify-content:center;backface-visibility:hidden;box-shadow:0 4px 14px rgba(0,0,0,.1);}
    .g5-front{background:linear-gradient(135deg,#667eea,#764ba2);font-size:24px;color:#fff;}
    .g5-back{background:#fff;transform:rotateY(180deg);}
    .g5-back img{width:75%;height:75%;object-fit:contain;}
    .g5-card.matched .g5-back{background:#f0fdf4;border:3px solid var(--ok);}
    /* ======== Game6: ãŠãŠãã•ãã‚‰ã¹ ======== */
    .g6-wrap{width:100%;max-width:520px;display:flex;flex-direction:column;align-items:center;gap:18px;}
    .g6-pair{display:flex;gap:20px;align-items:flex-end;justify-content:center;width:100%;flex-wrap:wrap;}
    .g6-animal{display:flex;flex-direction:column;align-items:center;gap:8px;cursor:pointer;border:3px solid transparent;border-radius:24px;padding:16px 20px;background:#fff;box-shadow:0 6px 20px rgba(0,0,0,.08);transition:transform .1s,border-color .2s;min-width:120px;}
    .g6-animal:active{transform:scale(.96);}
    .g6-animal img{width:100px;height:100px;object-fit:contain;display:block;}
    .g6-animal .g6-name{font-size:20px;font-weight:900;}
    .g6-animal.correct{border-color:var(--ok);background:#f0fdf4;}
    .g6-animal.wrong{border-color:var(--ng);background:#fffbeb;opacity:.7;}
    /* ======== Game7: ã“ã¨ã°ã‹ã‚“ã›ã„ ======== */
    .g7-wrap{width:100%;max-width:420px;display:flex;flex-direction:column;align-items:center;gap:18px;}
    .g7-word{display:flex;gap:8px;justify-content:center;align-items:center;font-size:48px;font-weight:900;background:#fff;border-radius:20px;padding:16px 24px;box-shadow:var(--shadow);font-family:'Zen Maru Gothic',sans-serif;}
    .g7-blank{display:inline-flex;align-items:center;justify-content:center;width:52px;height:60px;border-radius:12px;border:3px dashed var(--accent);color:var(--accent);font-size:24px;}
    .g7-choices{display:grid;grid-template-columns:1fr 1fr;gap:12px;width:100%;}
    .g7-choice{background:#fff;border:3px solid transparent;border-radius:18px;padding:14px;font-size:36px;font-weight:900;cursor:pointer;box-shadow:0 4px 16px rgba(0,0,0,.08);transition:transform .1s,border-color .2s;font-family:'Zen Maru Gothic',sans-serif;}
    .g7-choice:active{transform:scale(.95);}
    .g7-choice.correct{border-color:var(--ok);background:#f0fdf4;}
    .g7-choice.wrong{border-color:var(--ng);background:#fffbeb;opacity:.7;}
    /* ======== Game8: ã©ã†ã¶ã¤ãƒ”ã‚¢ãƒ ======== */
    .g8-wrap{width:100%;max-width:600px;display:flex;flex-direction:column;align-items:center;gap:16px;}
    .g8-keyboard{display:flex;gap:6px;justify-content:center;width:100%;padding:8px;}
    .g8-key{flex:1;display:flex;flex-direction:column;align-items:center;gap:4px;background:#fff;
            border:2px solid #ddd;border-radius:0 0 16px 16px;padding:8px 4px 12px;cursor:pointer;
            transition:transform .08s,background .15s;box-shadow:0 4px 10px rgba(0,0,0,.1);
            min-height:120px;justify-content:flex-end;}
    .g8-key:active{transform:scale(.93) translateY(2px);background:#fffbe0;}
    .g8-key img{width:48px;height:48px;object-fit:contain;}
    .g8-key .g8-note{font-size:17px;font-weight:900;margin-top:4px;}
    .g8-key .g8-animal{font-size:11px;color:var(--muted);}
    .g8-key.correct{background:#f0fdf4;border-color:var(--ok);animation:g8flash .5s;}
    .g8-key.wrong{background:#fff7ed;border-color:var(--ng);}
    .g8-key.inactive{opacity:.3;}
    @keyframes g8flash{0%{transform:scale(1)}30%{transform:scale(1.12)}100%{transform:scale(1)}}
    .g8-key.dancing img{animation:g8dance .65s ease;}
    @keyframes g8dance{0%{transform:scale(1) rotate(0)}20%{transform:scale(1.4) rotate(-18deg)}45%{transform:scale(1.2) rotate(14deg)}65%{transform:scale(1.3) rotate(-10deg)}80%{transform:scale(1.15) rotate(6deg)}100%{transform:scale(1) rotate(0)}}
    .g8-key.guide{background:#fff9c4;border-color:#fbbf24;animation:g8guide .55s ease-in-out infinite alternate;}
    @keyframes g8guide{from{transform:scaleY(1)}to{transform:scaleY(1.06)}}
    .g8-key.melody-active{background:#e0f2fe;border-color:#38bdf8;}
    .g8-quiz-label{font-size:44px;font-weight:900;background:#fff;padding:10px 40px;
                   border-radius:999px;box-shadow:var(--shadow);letter-spacing:.05em;}
  </style>
</head>
<body>
<canvas id="confetti"></canvas>
<button class="back-btn" id="backBtn">â† ã‚‚ã©ã‚‹</button>

<div class="wrap">
  <!-- ãƒ¡ãƒ‹ãƒ¥ãƒ¼ -->
  <div class="screen active" id="menuScreen">
    <div class="menu-title">ğŸ® ã‚­ãƒƒã‚º ã‚²ãƒ¼ãƒ </div>
    <div class="menu-sub">ã‚ãã³ãŸã„ ã‚²ãƒ¼ãƒ ã‚’ ãˆã‚‰ã‚“ã§ã­ï¼</div>
    <div class="game-cards">
      <div class="game-card" id="cardG1"><div class="card-icon">ğŸ¯</div><div class="card-title">ãªã¾ãˆ ã‚ã¦ã‚²ãƒ¼ãƒ </div><div class="card-desc">ã©ã†ã¶ã¤ã® ãˆã‚’ ã¿ã¦<br>ãªã¾ãˆã‚’ ã‚ã¦ã‚ˆã†ï¼</div></div>
      <div class="game-card" id="cardG2"><div class="card-icon">ğŸš‚</div><div class="card-title">ã©ã†ã¶ã¤åˆ—è»Š</div><div class="card-desc">ã‚Œã£ã—ã‚ƒã« ã®ã£ãŸ ã©ã†ã¶ã¤ã‚’<br>ã‹ããˆã‚ˆã†ï¼</div></div>
      <div class="game-card" id="cardG3"><div class="card-icon">âœï¸</div><div class="card-title">ã²ã‚‰ãŒãª ãŠã¼ãˆã‚ˆã†</div><div class="card-desc">ã²ã‚‰ãŒãªã® ã‚«ãƒ¼ãƒ‰ã‚’ ã¿ãŸã‚Š<br>ã‚¯ã‚¤ã‚ºã§ ã‚ãã¼ã†ï¼</div></div>
      <div class="game-card" id="cardG4"><div class="card-icon">ğŸ”Š</div><div class="card-title">ãªãã”ãˆ ã‚ã¦ã‚²ãƒ¼ãƒ </div><div class="card-desc">ã©ã†ã¶ã¤ã® ãªãã”ãˆã‚’ ãã„ã¦<br>ãˆã‚’ ãˆã‚‰ã¼ã†ï¼</div></div>
      <div class="game-card" id="cardG5"><div class="card-icon">ğŸƒ</div><div class="card-title">ã‚ãã‚Šã‚ã‚ã›</div><div class="card-desc">ãŠãªã˜ ã©ã†ã¶ã¤ã‚’ ã¿ã¤ã‘ã‚ˆã†ï¼<br>ãœã‚“ã¶ ãã‚ãˆã¦ã­ï¼</div></div>
      <div class="game-card" id="cardG6"><div class="card-icon">ğŸ“</div><div class="card-title">ãŠãŠãã• ãã‚‰ã¹</div><div class="card-desc">ã©ã£ã¡ã® ã©ã†ã¶ã¤ãŒ<br>ãŠãŠãã„ã‹ãªï¼Ÿ</div></div>
      <div class="game-card" id="cardG7"><div class="card-icon">âœï¸</div><div class="card-title">ã“ã¨ã° ã‹ã‚“ã›ã„</div><div class="card-desc">ã©ã†ã¶ã¤ã® ãªã¾ãˆã®<br>ã‚‚ã˜ã‚’ ãˆã‚‰ã‚“ã§ã­ï¼</div></div>
      <div class="game-card" id="cardG8">
        <div class="card-icon">ğŸ¹</div>
        <div class="card-title">ã©ã†ã¶ã¤ ãƒ”ã‚¢ãƒ</div>
        <div class="card-desc">ã©ã†ã¶ã¤ã¨ ã„ã£ã—ã‚‡ã«<br>ãƒ‰ãƒ¬ãƒŸã‚’ ãŠã¼ãˆã‚ˆã†ï¼</div>
      </div>
    </div>
  </div>

  <!-- Game1 Start -->
  <div class="screen" id="g1StartScreen">
    <div class="start-title">ğŸ¯ ãªã¾ãˆ ã‚ã¦ã‚²ãƒ¼ãƒ </div>
    <div class="start-sub">ã©ã†ã¶ã¤ã® ãˆã‚’ ã¿ã¦ã€ãªã¾ãˆã‚’ ã‚ã¦ã‚ˆã†ï¼</div>
    <div class="level-select">
      <button class="btn lv active" data-lv="1">Lv1 ã‹ã‚“ãŸã‚“</button>
      <button class="btn lv" data-lv="2">Lv2 ã‚€ãšã‹ã—ã„</button>
    </div>
    <div class="rounds-select">
      <button class="btn rd active" data-rd="5">5ã‚‚ã‚“</button>
      <button class="btn rd" data-rd="10">10ã‚‚ã‚“</button>
      <button class="btn rd" data-rd="0">ãœã‚“ã¶</button>
    </div>
    <div class="start-sub" style="font-size:12px;">Lv1=ãˆã‚’ã¿ã¦4ã¤ã‹ã‚‰ãˆã‚‰ã¶ã€€Lv2=ãƒ’ãƒ³ãƒˆã§4ã¤ã‹ã‚‰ãˆã‚‰ã¶</div>
    <button class="btn accent" id="g1StartBtn">ğŸµ ã‚ãã¶ï¼</button>
    <button class="animal-toggle-btn" id="animalToggleBtn">ğŸ”§ ã§ã¦ãã‚‹ ã©ã†ã¶ã¤ã‚’ ãˆã‚‰ã¶ â–¼</button>
    <div class="animal-select-wrap" id="animalSelectWrap">
      <div class="animal-select" id="animalSelect"></div>
      <div style="display:flex;gap:10px;">
        <button class="btn" id="g1SelectAll">ãœã‚“ã¶ ãˆã‚‰ã¶</button>
        <button class="btn" id="g1DeselectAll">ãœã‚“ã¶ ã¯ãšã™</button>
      </div>
    </div>
  </div>
  <!-- Game1 Play -->
  <div class="screen" id="g1GameScreen">
    <div class="game-header">
      <div class="badge" id="roundBadge">ğŸ¾ 1/5</div>
      <div class="badge" id="scoreBadge">â­ 0</div>
      <div class="badge" id="lvBadge">Lv1</div>
    </div>
    <div class="game-main">
      <div class="prompt-card">
        <div class="prompt-label" id="promptLabel">ã“ã® ã©ã†ã¶ã¤ã¯ ãªã«ï¼Ÿ</div>
        <div class="big-icon" id="bigIcon"></div>
        <button class="cry-btn" id="cryBtn" style="display:none;">ğŸ”Š ãªãã”ãˆ</button>
        <div class="correct-reveal" id="correctReveal"></div>
        <div class="hint-text" id="hintText">ã“ãŸãˆã‚’ ã‚¿ãƒƒãƒ—ã—ã¦ã­</div>
        <div class="feedback-overlay" id="feedback"><div class="fb-circle" id="fbCircle"></div><div class="fb-label" id="fbLabel"></div></div>
      </div>
      <div class="choices-card"><div class="choices-grid" id="choicesGrid"></div></div>
    </div>
  </div>
  <!-- Game1 Result -->
  <div class="screen" id="g1ResultScreen">
    <div class="result-card">
      <div class="result-medal" id="resultMedal"></div>
      <div class="result-stars" id="resultStars"></div>
      <div class="result-score" id="resultScore"></div>
      <div class="result-sub" id="resultSub"></div>
      <div class="result-detail" id="resultDetail"></div>
      <div class="result-btns">
        <button class="btn accent" id="g1RetryBtn">ğŸµ ã‚‚ã†ã„ã¡ã©ï¼</button>
        <button class="btn" id="g1ZukanBtn">ğŸ“– ãšã‹ã‚“</button>
      </div>
    </div>
  </div>
  <!-- Game1 Zukan -->
  <div class="screen" id="g1BookScreen">
    <div class="start-title">ğŸ“– ã©ã†ã¶ã¤ ãšã‹ã‚“</div>
    <div class="start-sub">ã‚¿ãƒƒãƒ—ã™ã‚‹ã¨ ãªãã”ãˆãŒ ãã‘ã‚‹ã‚ˆï¼</div>
    <div class="zukan-grid" id="zukanGrid"></div>
    <button class="btn" id="g1BookBack">â† ã‚‚ã©ã‚‹</button>
  </div>

  <!-- Game2 -->
  <div class="screen" id="g2Screen">
    <div class="g2-wrap">
      <div class="g2-header" style="margin-bottom:12px;">
        <div>
          <h2 style="font-size:clamp(18px,3.2vw,26px);margin:0;">ğŸš‚ ã©ã†ã¶ã¤åˆ—è»Š</h2>
          <p class="g2-subtitle" id="g2Subtitle">ã©ã†ã¶ã¤ã‚’ã‚¿ãƒƒãƒ—ã™ã‚‹ã¨æ•°ãˆã‚‹ã‚ˆ</p>
        </div>
        <div style="display:flex;gap:8px;align-items:center;">
          <div class="g2-pill"><div><strong id="g2LevelText">Lv 1</strong><br/><small id="g2ModeText">ã¯ã‚“ã„: 1ã€œ5</small></div></div>
          <button class="g2-iconBtn" id="g2OpenSettings">âš™</button>
        </div>
      </div>
      <section class="g2-panel">
        <div class="g2-scene">
          <div class="g2-prompt">
            <p class="q" id="g2Question">ã„ãã¤ï¼Ÿ</p>
            <p class="hint"><span id="g2HintRange">ï¼ˆ1ã€œ5ï¼‰</span><span id="g2HintVoice">ãƒ»ã“ãˆ: ON</span><span id="g2HintPractice">ãƒ»ã‚Œã‚“ã—ã‚…ã†: OFF</span></p>
          </div>
          <div class="lane" id="lane">
            <div class="cloud" style="left:-160px;animation-duration:11s;top:12%;"></div>
            <div class="cloud" style="left:-240px;animation-duration:15s;top:22%;transform:scale(.8);"></div>
            <div class="ground"></div><div class="track"></div>
            <div class="station"><span>ãˆãã§</span><strong id="g2StationText">ãƒ”ãƒ³ãƒãƒ³ï¼</strong><span style="margin-top:8px;">ã®ã£ãŸã‚Š</span><span>ãŠã‚ŠãŸã‚Š</span></div>
            <div class="train" id="train"></div>
          </div>
        </div>
        <div class="g2-answers" id="g2Answers"></div>
        <div class="g2-footerRow">
          <div class="g2-progress"><span style="font-weight:900;">ã‚¹ã‚¿ãƒ³ãƒ—</span><div class="g2-bar"><i id="g2BarFill"></i></div><span id="g2StampText" style="font-weight:900;">0/5</span></div>
          <div class="g2-mini">
            <button class="g2-smallBtn" id="g2SpeakBtn">ã€Œã„ãã¤ï¼Ÿã€</button>
            <button class="g2-smallBtn" id="g2CountAllBtn">ãœã‚“ã¶ ã‹ããˆã‚‹</button>
            <button class="g2-smallBtn" id="g2ResetBtn">ãƒªã‚»ãƒƒãƒˆ</button>
          </div>
        </div>
        <div class="g2-book">
          <div class="g2-bookTop"><div class="g2-bookTitle">ğŸ“˜ ã‚·ãƒ¼ãƒ«ã¡ã‚‡ã†</div><div class="g2-animalShelf" id="g2AnimalShelf"></div></div>
          <div class="g2-stickers" id="g2StickerGrid"></div>
          <div style="color:var(--muted);font-size:12px;">â€» ã›ã„ã‹ã„ã§ â­ ãŒ1ã“ã€‚10ã“ã§ 1ãƒšãƒ¼ã‚¸ï¼</div>
        </div>
      </section>
    </div>
  </div>

  <!-- Game3 -->
  <div class="screen" id="g3Screen">
    <div class="g3-wrap">
      <div style="font-size:26px;font-weight:900;">âœï¸ ã²ã‚‰ãŒãª ãŠã¼ãˆã‚ˆã†ï¼</div>
      <div class="g3-charRow" id="g3CharRow">
        <button class="g3-charBtn active" data-set="basic">ãã»ã‚“</button>
        <button class="g3-charBtn" data-set="dakuten">ã ããŠã‚“</button>
        <button class="g3-charBtn" data-set="katakana">ã‚«ã‚¿ã‚«ãƒŠ</button>
      </div>
      <div class="g3-modeRow" id="g3ModeRow">
        <button class="g3-modeBtn active" data-mode="flash">ğŸ“– ã¿ã‚‹</button>
        <button class="g3-modeBtn" data-mode="quiz">ğŸ¯ ã‚¯ã‚¤ã‚º</button>
        <button class="g3-modeBtn" data-mode="word">ğŸ§© ã“ã¨ã°</button>
        <button class="g3-modeBtn" data-mode="stats">ğŸ“Š ã›ã„ã›ã</button>
      </div>
      <div id="g3Flash">
        <div class="g3-card" id="g3Card" style="margin-bottom:12px;">
          <div class="g3-emoji" id="g3Emoji">ğŸœ</div>
          <div class="g3-hira" id="g3Hira">ã‚</div>
          <div class="g3-romaji" id="g3Romaji">A</div>
          <div class="g3-word" id="g3Word">ã‚ã‚Š</div>
          <div class="g3-rateBadge" id="g3Rate" style="display:none;"></div>
          <div class="g3-tapHint">ã‚¿ãƒƒãƒ—ã§ ã‚ˆã‚“ã§ãã‚Œã‚‹ã‚ˆï¼</div>
        </div>
        <div style="display:flex;gap:10px;justify-content:center;margin-bottom:12px;">
          <div class="g3-navRow">
            <button class="g3-navBtn g3-navPrev" id="g3Prev">â—€</button>
            <div class="g3-progInfo" id="g3Prog">1 / 46</div>
            <button class="g3-navBtn g3-navNext" id="g3Next">â–¶</button>
          </div>
        </div>
        <div style="text-align:center;margin-bottom:8px;"><button class="g3-traceBtn" id="g3TraceBtn">âœï¸ ãªãã£ã¦ ã‚Œã‚“ã—ã‚…ã†</button></div>
        <div class="g3-dots" id="g3Dots"></div>
      </div>
      <div id="g3Quiz" style="display:none;">
        <div class="g3-quizWrap">
          <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:center;">
            <button class="g3-charBtn g3-qTotalBtn" data-total="5">5ã‚‚ã‚“</button>
            <button class="g3-charBtn g3-qTotalBtn active" data-total="10">10ã‚‚ã‚“</button>
            <button class="g3-charBtn g3-qTotalBtn" data-total="15">15ã‚‚ã‚“</button>
            <button class="g3-charBtn g3-qTotalBtn" data-total="20">20ã‚‚ã‚“</button>
            <button class="g3-charBtn" id="g3WrongOnlyBtn">âŒ ã¾ã¡ãŒã„ã®ã¿</button>
          </div>
          <div class="g3-scoreBadge" id="g3Score">â­ 0 / 10ã‚‚ã‚“</div>
          <div id="g3QuizMain">
            <div class="g3-question" id="g3QEmoji">ğŸœ</div>
            <div class="g3-instruction" id="g3QText"></div>
            <div class="g3-options" id="g3Opts"></div>
          </div>
          <div id="g3QuizResult" style="display:none;text-align:center;padding:20px 0;">
            <div class="g3-scoreBadge" style="font-size:20px;padding:14px 28px;" id="g3QuizResultScore"></div>
            <div style="margin-top:16px;display:flex;gap:12px;justify-content:center;flex-wrap:wrap;">
              <button class="g3-modeBtn active" id="g3QuizRetry">ã‚‚ã†ã„ã¡ã©</button>
              <button class="g3-modeBtn" id="g3QuizRetryWrong" style="display:none;">âŒ ã¾ã¡ãŒã„ã®ã¿</button>
            </div>
          </div>
        </div>
      </div>
      <div id="g3Word" style="display:none;">
        <div class="g3-wordGame">
          <div class="g3-scoreBadge" id="g3WScore">â­ 0 ã‚‚ã‚“ ã›ã„ã‹ã„ï¼</div>
          <div class="g3-instruction" id="g3WText"></div>
          <div class="g3-wordTarget" id="g3WSlots"></div>
          <div class="g3-wordPieces" id="g3WPieces"></div>
        </div>
      </div>
      <div id="g3Stats" style="display:none;">
        <div class="g3-statsWrap">
          <div class="g3-scoreBadge">ğŸ“Š ã›ã„ã›ãã²ã‚‡ã†</div>
          <div class="g3-statsGrid" id="g3StatsGrid"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Game4: ãªãã”ãˆã‚ã¦ã‚²ãƒ¼ãƒ  -->
  <div class="screen" id="g4Screen">
    <div class="g4-wrap">
      <div style="font-size:22px;font-weight:900;">ğŸ”Š ãªãã”ãˆ ã‚ã¦ã‚²ãƒ¼ãƒ </div>
      <div class="badge" id="g4Badge">ğŸ¾ 1/5</div>
      <button class="g4-speaker" id="g4Speaker">ğŸ”Š</button>
      <div style="font-size:15px;color:var(--muted);">ãªãã”ãˆã‚’ ãã„ã¦ ã©ã†ã¶ã¤ã‚’ ãˆã‚‰ã‚“ã§ã­ï¼</div>
      <div class="g4-grid" id="g4Grid"></div>
    </div>
  </div>
  <!-- Game4 Result -->
  <div class="screen" id="g4ResultScreen">
    <div class="result-card">
      <div class="result-medal" id="g4Medal"></div>
      <div class="result-stars" id="g4Stars"></div>
      <div class="result-score" id="g4Score"></div>
      <div class="result-sub" id="g4Sub"></div>
      <div class="result-btns">
        <button class="btn accent" id="g4RetryBtn">ğŸµ ã‚‚ã†ã„ã¡ã©ï¼</button>
        <button class="btn" id="g4HomeBtn">ğŸ  ã‚‚ã©ã‚‹</button>
      </div>
    </div>
  </div>

  <!-- Game5: ã‚ãã‚Šã‚ã‚ã› -->
  <div class="screen" id="g5Screen">
    <div class="g5-wrap">
      <div style="font-size:22px;font-weight:900;">ğŸƒ ã‚ãã‚Šã‚ã‚ã›</div>
      <div style="display:flex;gap:10px;justify-content:center;">
        <button class="btn lv active" id="g5Lv1">ãƒ¬ãƒ™ãƒ«1 (4ãƒšã‚¢)</button>
        <button class="btn lv" id="g5Lv2">ãƒ¬ãƒ™ãƒ«2 (6ãƒšã‚¢)</button>
        <button class="btn lv" id="g5Lv3">ãƒ¬ãƒ™ãƒ«3 (8ãƒšã‚¢)</button>
      </div>
      <div class="badge" id="g5Badge">ãƒšã‚¢: 0 / 4</div>
      <div id="g5Complete" style="display:none;text-align:center;">
        <div style="font-size:48px;">ğŸ‰</div>
        <div style="font-size:24px;font-weight:900;">ãœã‚“ã¶ ãã‚ã£ãŸã‚ˆï¼</div>
        <div style="display:flex;gap:10px;justify-content:center;margin-top:12px;">
          <button class="btn accent" id="g5RetryBtn">ğŸµ ã‚‚ã†ã„ã¡ã©ï¼</button>
          <button class="btn" id="g5HomeBtn">ğŸ  ã‚‚ã©ã‚‹</button>
        </div>
      </div>
      <div class="g5-grid" id="g5Grid"></div>
    </div>
  </div>

  <!-- Game6: ãŠãŠãã•ãã‚‰ã¹ -->
  <div class="screen" id="g6Screen">
    <div class="g6-wrap">
      <div style="font-size:22px;font-weight:900;">ğŸ“ ãŠãŠãã• ãã‚‰ã¹</div>
      <div class="badge" id="g6Badge">ğŸ¾ 1/10</div>
      <div style="font-size:18px;font-weight:900;color:var(--accent);">ã©ã£ã¡ãŒ ãŠãŠãã„ï¼Ÿ</div>
      <div class="g6-pair" id="g6Pair"></div>
    </div>
  </div>
  <!-- Game6 Result -->
  <div class="screen" id="g6ResultScreen">
    <div class="result-card">
      <div class="result-medal" id="g6Medal"></div>
      <div class="result-stars" id="g6Stars"></div>
      <div class="result-score" id="g6Score"></div>
      <div class="result-sub" id="g6Sub"></div>
      <div class="result-btns">
        <button class="btn accent" id="g6RetryBtn">ğŸµ ã‚‚ã†ã„ã¡ã©ï¼</button>
        <button class="btn" id="g6HomeBtn">ğŸ  ã‚‚ã©ã‚‹</button>
      </div>
    </div>
  </div>

  <!-- Game7: ã“ã¨ã°ã‹ã‚“ã›ã„ -->
  <div class="screen" id="g7Screen">
    <div class="g7-wrap">
      <div style="font-size:22px;font-weight:900;">âœï¸ ã“ã¨ã° ã‹ã‚“ã›ã„</div>
      <div style="display:flex;gap:10px;justify-content:center;">
        <button class="btn lv" id="g7Easy">ã‹ã‚“ãŸã‚“</button>
        <button class="btn lv" id="g7Normal">ãµã¤ã†</button>
      </div>
      <div class="badge" id="g7Badge">ğŸ¾ 1/10</div>
      <div class="big-icon" id="g7Icon"></div>
      <div class="g7-word" id="g7Word"></div>
      <div class="g7-choices" id="g7Choices"></div>
    </div>
  </div>
  <!-- Game7 Result -->
  <div class="screen" id="g7ResultScreen">
    <div class="result-card">
      <div class="result-medal" id="g7Medal"></div>
      <div class="result-stars" id="g7Stars"></div>
      <div class="result-score" id="g7Score"></div>
      <div class="result-sub" id="g7Sub"></div>
      <div class="result-btns">
        <button class="btn accent" id="g7RetryBtn">ğŸµ ã‚‚ã†ã„ã¡ã©ï¼</button>
        <button class="btn" id="g7HomeBtn">ğŸ  ã‚‚ã©ã‚‹</button>
      </div>
    </div>
  </div>
  <!-- Game8: ã©ã†ã¶ã¤ãƒ”ã‚¢ãƒ -->
  <div class="screen" id="g8Screen">
    <div class="g8-wrap">
      <div class="level-select" id="g8LvSelect">
        <button class="btn lv active" id="g8LvEasy">ã‹ã‚“ãŸã‚“</button>
        <button class="btn lv" id="g8LvNormal">ãµã¤ã†</button>
        <button class="btn lv" id="g8LvHard">ã‚€ãšã‹ã—</button>
      </div>
      <div id="g8QuizLabel" class="g8-quiz-label" style="display:none;"></div>
      <button class="btn" id="g8AgainBtn" style="display:none;">ğŸ” ã‚‚ã†ã„ã¡ã©</button>
      <div class="g8-keyboard" id="g8Keyboard"></div>
      <button class="btn accent" id="g8StartQuizBtn">ğŸµ ã‚¯ã‚¤ã‚º ã‚¹ã‚¿ãƒ¼ãƒˆï¼</button>
      <button class="btn" id="g8RensouBtn" style="display:none;">ğŸ¹ ã‚Œã‚“ãã†ãƒ¢ãƒ¼ãƒ‰</button>
      <div id="g8FreeTip" style="font-size:15px;color:var(--muted);">ã™ããª ã‘ã‚“ã°ã‚“ã‚’ ãŠã—ã¦ã¿ã‚ˆã†ï¼</div>
      <div id="g8MelodySection" style="display:none;flex-direction:column;align-items:center;gap:8px;">
        <div style="font-size:14px;font-weight:700;color:var(--muted);">â™ª ã˜ã©ã† ãˆã‚“ãã†</div>
        <div style="display:flex;gap:8px;">
          <button class="btn g8-melody-btn" data-melody="0">ğŸŒŸ ãã‚‰ãã‚‰ã¼ã—</button>
          <button class="btn g8-melody-btn" data-melody="1">ğŸ¦‹ ã¡ã‚‡ã†ã¡ã‚‡</button>
        </div>
        <button class="btn" id="g8MelodyStopBtn">â¹ ã¨ã‚ã‚‹</button>
      </div>
    </div>
  </div>
  <!-- Game8 Result -->
  <div class="screen" id="g8ResultScreen">
    <div class="result-card">
      <div class="result-medal" id="g8Medal"></div>
      <div class="result-stars" id="g8Stars"></div>
      <div class="result-score" id="g8Score"></div>
      <div class="result-sub" id="g8Sub"></div>
      <div class="result-btns">
        <button class="btn accent" id="g8RetryBtn">ğŸ¹ ã‚‚ã†ã„ã¡ã©ï¼</button>
        <button class="btn" id="g8HomeBtn">ğŸ  ã‚‚ã©ã‚‹</button>
      </div>
    </div>
  </div>
</div>
<div class="streak-msg" id="streakMsg"></div>
<div class="g2-toast" id="g2Toast"></div>
<div class="g2-confetti" id="g2Confetti"></div>
<div class="g3-celeb" id="g3Celeb"></div>
<div class="g3-traceOverlay" id="g3TraceOverlay">
  <canvas class="g3-traceCanvas" id="g3TraceCanvas" width="320" height="320"></canvas>
  <button class="g3-traceClose" id="g3TraceClose">ã¨ã˜ã‚‹</button>
</div>

<!-- Game2 Settings Modal -->
<div class="g2-modalBg" id="g2ModalBg">
  <div class="g2-modal">
    <div class="g2-modalHeader"><div>ã›ã£ã¦ã„</div><button class="g2-iconBtn" id="g2CloseSettings">âœ•</button></div>
    <div class="g2-modalBody">
      <div class="g2-row"><div><label>ã‹ãšã® ã¯ã‚“ã„</label><small>ã“ãŸãˆã® ã•ã„ã ã„ã™ã†</small></div><select id="g2AgeMode"><option value="2">1ã€œ2</option><option value="3">1ã€œ3</option><option value="5">1ã€œ5</option></select></div>
      <div class="g2-row"><div><label>ã“ãˆï¼ˆèª­ã¿ä¸Šã’ï¼‰</label></div><input id="g2VoiceOn" type="checkbox"/></div>
      <div class="g2-row"><div><label>ã‚„ã•ã—ãè‡ªå‹•èª¿æ•´</label><small>ã¤ã¾ãšã„ãŸã‚‰ç¯„å›²ã‚’ç‹­ã‚ã‚‹</small></div><input id="g2AutoEase" type="checkbox"/></div>
      <div class="g2-row"><div><label>ã‚Œã‚“ã—ã‚…ã†ãƒ¢ãƒ¼ãƒ‰</label><small>åŒã˜æ•°ã‚’ 3å›ãã‚Šè¿”ã™</small></div><input id="g2PracticeMode" type="checkbox"/></div>
      <div class="g2-row"><div><label>ãˆãã§ ã®ã‚‹/ãŠã‚Šã‚‹</label></div><input id="g2StationChange" type="checkbox"/></div>
      <div class="g2-row"><div><label>ãŸã—ã–ã‚“ãƒ¢ãƒ¼ãƒ‰</label><small>æœ€åˆã«NåŒ¹â†’é§…ã§MåŒ¹ã®ã‚‹â†’åˆè¨ˆã¯ï¼Ÿ</small></div><input id="g2MathMode" type="checkbox"/></div>
      <div class="g2-row"><div><label>ã‚¹ãƒ”ãƒ¼ãƒ‰ãƒãƒ£ãƒ¬ãƒ³ã‚¸</label><small>åˆ—è»ŠãŒé€šã‚Šã™ãã‚‹ï¼è¨˜æ†¶ã§ç­”ãˆã‚ˆã†</small></div><input id="g2SpeedMode" type="checkbox"/></div>
      <div class="g2-row"><div><label>ã”ã»ã†ã³æ¼”å‡º</label></div><input id="g2FancyRewards" type="checkbox"/></div>
    </div>
    <div class="g2-modalFooter"><button class="g2-smallBtn" id="g2ApplySettings">OK</button></div>
  </div>
</div>

<script>
// ============================================================
//  å…±é€š
// ============================================================
const allScreens=['menuScreen','g1StartScreen','g1GameScreen','g1ResultScreen','g1BookScreen','g2Screen','g3Screen','g4Screen','g4ResultScreen','g5Screen','g6Screen','g6ResultScreen','g7Screen','g7ResultScreen','g8Screen','g8ResultScreen'];
function showScreen(id){allScreens.forEach(s=>document.getElementById(s).classList.remove('active'));document.getElementById(id).classList.add('active');document.getElementById('backBtn').classList.toggle('visible',id!=='menuScreen');}
function goHome(){showScreen('menuScreen');if(typeof g2Stop==='function')g2Stop();if(typeof g4Stop==='function')g4Stop();if(typeof g5Stop==='function')g5Stop();if(typeof g6Stop==='function')g6Stop();if(typeof g7Stop==='function')g7Stop();if(typeof g8Stop==='function')g8Stop();}
function startGame1(){showScreen('g1StartScreen');g1RenderAnimalSelect();}
function startGame2(){showScreen('g2Screen');g2Init();}
function startGame3(){showScreen('g3Screen');if(typeof g3Init==='function')g3Init();}
function startGame4(){showScreen('g4Screen');if(typeof g4Init==='function')g4Init();}
function startGame5(){showScreen('g5Screen');if(typeof g5Init==='function')g5Init();}
function startGame6(){showScreen('g6Screen');if(typeof g6Init==='function')g6Init();}
function startGame7(){showScreen('g7Screen');if(typeof g7Init==='function')g7Init();}
function startGame8(){showScreen('g8Screen');if(typeof g8Init==='function')g8Init();}

document.getElementById('backBtn').addEventListener('click',goHome);
document.getElementById('cardG1').addEventListener('click',startGame1);
document.getElementById('cardG2').addEventListener('click',startGame2);
document.getElementById('cardG3').addEventListener('click',startGame3);
document.getElementById('cardG4').addEventListener('click',startGame4);
document.getElementById('cardG5').addEventListener('click',startGame5);
document.getElementById('cardG6').addEventListener('click',startGame6);
document.getElementById('cardG7').addEventListener('click',startGame7);
document.getElementById('cardG8').addEventListener('click',startGame8);

// TTS (Googleç¿»è¨³TTSå„ªå…ˆã€ãƒã‚¤ãƒ†ã‚£ãƒ–TTSã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯)
let _ttsAudio=null,_nativeVoice=null;
(function(){
  if(!('speechSynthesis' in window))return;
  function pick(){const v=speechSynthesis.getVoices(),ja=v.filter(x=>x.lang&&x.lang.startsWith('ja'));
    const best=ja.find(x=>/natural|neural/i.test(x.name))||ja.find(x=>/online/i.test(x.name)&&!/desktop/i.test(x.name))||ja.find(x=>/google/i.test(x.name))||ja.find(x=>!x.localService);
    if(best)_nativeVoice=best;}
  speechSynthesis.onvoiceschanged=pick;pick();
})();
function speak(text,cb){
  function nativeFallback(){if(_nativeVoice){speechSynthesis.cancel();const u=new SpeechSynthesisUtterance(text);u.voice=_nativeVoice;u.lang='ja-JP';u.rate=0.85;u.pitch=1.1;u.volume=1.0;if(cb)u.onend=cb;u.onerror=function(){if(cb)cb();};speechSynthesis.speak(u);}else if(cb)cb();}
  try{if(_ttsAudio){_ttsAudio.pause();_ttsAudio=null;}const url="https://translate.google.com/translate_tts?ie=UTF-8&client=tw-ob&tl=ja&q="+encodeURIComponent(text);_ttsAudio=new Audio(url);_ttsAudio.volume=1.0;if(cb)_ttsAudio.onended=cb;_ttsAudio.onerror=function(){nativeFallback();};_ttsAudio.play().catch(()=>{nativeFallback();});}catch(e){nativeFallback();}
}

// Audio
const AudioCtx=window.AudioContext||window.webkitAudioContext;let audioCtx=null;
function getAudioCtx(){if(!audioCtx)audioCtx=new AudioCtx();return audioCtx;}
function playCorrectSound(){try{const c=getAudioCtx();[523.25,659.25,783.99].forEach((f,i)=>{const o=c.createOscillator(),g=c.createGain();o.type='sine';o.frequency.value=f;g.gain.setValueAtTime(0.15,c.currentTime);g.gain.exponentialRampToValueAtTime(0.01,c.currentTime+0.6);o.connect(g);g.connect(c.destination);o.start(c.currentTime+i*0.1);o.stop(c.currentTime+0.7+i*0.1);});}catch(e){}}
function playWrongSound(){try{const c=getAudioCtx();const o=c.createOscillator(),g=c.createGain();o.type='square';o.frequency.value=200;g.gain.setValueAtTime(0.1,c.currentTime);g.gain.exponentialRampToValueAtTime(0.01,c.currentTime+0.4);o.connect(g);g.connect(c.destination);o.start(c.currentTime);o.stop(c.currentTime+0.4);}catch(e){}}
function playTrainDepart(){try{const c=getAudioCtx();const o=c.createOscillator(),g=c.createGain();o.type='sawtooth';o.frequency.setValueAtTime(200,c.currentTime);o.frequency.linearRampToValueAtTime(600,c.currentTime+0.4);g.gain.setValueAtTime(0.08,c.currentTime);g.gain.exponentialRampToValueAtTime(0.01,c.currentTime+0.5);o.connect(g);g.connect(c.destination);o.start(c.currentTime);o.stop(c.currentTime+0.5);}catch(e){}}
function playTrainBrake(){try{const c=getAudioCtx();const o=c.createOscillator(),g=c.createGain();o.type='sawtooth';o.frequency.setValueAtTime(500,c.currentTime);o.frequency.linearRampToValueAtTime(100,c.currentTime+0.5);g.gain.setValueAtTime(0.08,c.currentTime);g.gain.exponentialRampToValueAtTime(0.01,c.currentTime+0.6);o.connect(g);g.connect(c.destination);o.start(c.currentTime);o.stop(c.currentTime+0.6);}catch(e){}}

// Confetti
const cnv=document.getElementById('confetti'),cCtx=cnv.getContext('2d');let confettiParts=[],confettiAnim=null;
function resizeCanvas(){cnv.width=innerWidth;cnv.height=innerHeight;}addEventListener('resize',resizeCanvas);resizeCanvas();
function launchConfetti(){confettiParts=[];const colors=['#ff4d6d','#ffd166','#06d6a0','#118ab2','#ef476f','#ffc43d','#1b9aaa','#ff6b6b'];for(let i=0;i<120;i++)confettiParts.push({x:Math.random()*cnv.width,y:Math.random()*cnv.height*-1,w:Math.random()*8+4,h:Math.random()*6+3,color:colors[i%colors.length],vx:(Math.random()-.5)*3,vy:Math.random()*4+2,rot:Math.random()*360,vr:(Math.random()-.5)*10,life:1});if(confettiAnim)cancelAnimationFrame(confettiAnim);animConfetti();}
function animConfetti(){cCtx.clearRect(0,0,cnv.width,cnv.height);let alive=false;confettiParts.forEach(p=>{if(p.life<=0)return;alive=true;p.x+=p.vx;p.y+=p.vy;p.rot+=p.vr;p.life-=.005;cCtx.save();cCtx.translate(p.x,p.y);cCtx.rotate(p.rot*Math.PI/180);cCtx.globalAlpha=Math.max(0,p.life);cCtx.fillStyle=p.color;cCtx.fillRect(-p.w/2,-p.h/2,p.w,p.h);cCtx.restore();});if(alive)confettiAnim=requestAnimationFrame(animConfetti);else cCtx.clearRect(0,0,cnv.width,cnv.height);}
function shuffle(a){const b=[...a];for(let i=b.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[b[i],b[j]]=[b[j],b[i]];}return b;}
function mkImg(key){const img=document.createElement('img');img.src='ã‚¤ãƒ©ã‚¹ãƒˆ/'+key+'.png';img.alt=key;img.draggable=false;return img;}
function playCry(animal,cb){if(animal.soundFile){const a=new Audio(animal.soundFile);a.volume=1.0;if(cb)a.onended=cb;a.onerror=function(){speak(animal.cry,cb);};a.play().catch(()=>{speak(animal.cry,cb);});}else{speak(animal.cry,cb);}}

// ============================================================
//  Game1: ãªã¾ãˆã‚ã¦ã‚²ãƒ¼ãƒ 
// ============================================================
(function(){
  const animals=[
    {key:"inu",name:"ã„ã¬",hint:"ãƒ¯ãƒ³ãƒ¯ãƒ³ï¼ã¨ ãªãã‚ˆ",cry:"ãƒ¯ãƒ³ãƒ¯ãƒ³ï¼",fact:"ã„ã¬ã¯ ã«ã‚“ã’ã‚“ã® ã„ã¡ã°ã‚“ã® ã¨ã‚‚ã ã¡ã€‚ã¯ãªãŒ ã¨ã¦ã‚‚ã„ã„ã‚ˆï¼",soundFile:"éŸ³å£°/inu.mp3"},
    {key:"neko",name:"ã­ã“",hint:"ãƒ‹ãƒ£ãƒ¼ã¨ ãªãã‚ˆ",cry:"ãƒ‹ãƒ£ãƒ¼ï¼",fact:"ã­ã“ã¯ 1ã«ã¡ã« 16ã˜ã‹ã‚“ã‚‚ ã­ã‚‹ã‚ˆã€‚ã²ã’ã§ ã¯ã°ã‚’ ã¯ã‹ã‚‹ã‚“ã ï¼",soundFile:"éŸ³å£°/neko.mp3"},
    {key:"kuma",name:"ãã¾",hint:"ã‚‚ã‚Šã« ã™ã‚“ã§ã„ã‚‹ã‚ˆ",cry:"ã‚¬ã‚ªãƒ¼ï¼",fact:"ãã¾ã¯ ãµã‚†ã« ã¨ã†ã¿ã‚“ã™ã‚‹ã‚ˆã€‚ã¯ã¡ã¿ã¤ãŒ ã ã„ã™ãï¼"},
    {key:"zou",name:"ãã†",hint:"ãªãŒã„ ã¯ãªãŒ ã‚ã‚‹ã‚ˆ",cry:"ãƒ‘ã‚ªãƒ¼ãƒ³ï¼",fact:"ãã†ã¯ ã‚Šãã® ã©ã†ã¶ã¤ã§ ã„ã¡ã°ã‚“ ãŠãŠãã„ã‚ˆã€‚ããŠãã‚Šã‚‡ããŒ ã™ã”ã„ï¼",soundFile:"éŸ³å£°/zou.mp3"},
    {key:"raion",name:"ã‚‰ã„ãŠã‚“",hint:"ãŸã¦ãŒã¿ãŒ ã‹ã£ã“ã„ã„ï¼",cry:"ã‚¬ã‚ªãƒ¼ï¼",fact:"ã‚‰ã„ãŠã‚“ã¯ ã€Œã²ã‚ƒãã˜ã‚…ã†ã® ãŠã†ã€ã€‚1ã«ã¡ã« 20ã˜ã‹ã‚“ ã­ã‚‹ã“ã¨ã‚‚ï¼",soundFile:"éŸ³å£°/raion.mp3"},
    {key:"pengin",name:"ãºã‚“ãã‚“",hint:"ã“ãŠã‚Šã® ã†ãˆã‚’ ã‚ã‚‹ãã‚ˆ",cry:"ãºãºãºã£ï¼",fact:"ãºã‚“ãã‚“ã¯ ã¨ã¹ãªã„ã‘ã© ãŠã‚ˆããŒ ã¨ãã„ã€‚ã˜ãã 36kmï¼",soundFile:"éŸ³å£°/ãƒšãƒ³ã‚®ãƒ³ã®é³´ãå£°.mp3"},
    {key:"kirin",name:"ãã‚Šã‚“",hint:"ã›ãŒ ã¨ã£ã¦ã‚‚ ãŸã‹ã„ã‚ˆ",cry:"ã‚‚ãã‚‚ã",fact:"ãã‚Šã‚“ã¯ ã›ãŒ 5ãƒ¡ãƒ¼ãƒˆãƒ« ã„ã˜ã‚‡ã†ã€‚ã—ãŸãŒ 50ã‚»ãƒ³ãƒã‚‚ ã‚ã‚‹ã‚ˆï¼"},
    {key:"hitsuji",name:"ã²ã¤ã˜",hint:"ã‚‚ã“ã‚‚ã“ã® ã‘ãŒ ã‚ã‚‹ã‚ˆ",cry:"ãƒ¡ã‚§ãƒ¼ï¼",fact:"ã²ã¤ã˜ã® ã‘ã¯ ã‚»ãƒ¼ã‚¿ãƒ¼ã« ãªã‚‹ã‚ˆã€‚ã‹ãŠã‚’ ãŠã¼ãˆã‚‹ã®ãŒ ã¨ãã„ï¼",soundFile:"éŸ³å£°/ãƒ’ãƒ„ã‚¸ã®é³´ãå£°.mp3"},
    {key:"buta",name:"ã¶ãŸ",hint:"ãƒ–ãƒ¼ãƒ–ãƒ¼ï¼ã¯ãªãŒ ã¾ã‚‹ã„ã‚ˆ",cry:"ãƒ–ãƒ¼ãƒ–ãƒ¼ï¼",fact:"ã¶ãŸã¯ ã¨ã¦ã‚‚ ã‚ãŸã¾ãŒ ã„ã„ã‚ˆã€‚ãã‚Œã„ãšãã§ ã™ãªã¶ã‚ãŒ ã™ãï¼",soundFile:"éŸ³å£°/buta.mp3"},
    {key:"koara",name:"ã‚³ã‚¢ãƒ©",hint:"ãƒ¦ãƒ¼ã‚«ãƒªã® ãã« ã„ã‚‹ã‚ˆ",cry:"ã™ã‚„ã™ã‚„",fact:"ã‚³ã‚¢ãƒ©ã¯ 1ã«ã¡ã« 22ã˜ã‹ã‚“ ã­ã‚‹ã‚ˆã€‚ãƒ¦ãƒ¼ã‚«ãƒªã® ã¯ã£ã±ã ã‘ ãŸã¹ã‚‹ã‚“ã ï¼"},
    {key:"hiyoko",name:"ã²ã‚ˆã“",hint:"ãŸã¾ã”ã‹ã‚‰ ã†ã¾ã‚ŒãŸã‚ˆï¼",cry:"ã´ã‚ˆã´ã‚ˆï¼",fact:"ã²ã‚ˆã“ã¯ ã«ã‚ã¨ã‚Šã® ã‚ã‹ã¡ã‚ƒã‚“ã ã‚ˆã€‚ã´ã‚ˆã´ã‚ˆ ãªãã‚ˆï¼",soundFile:"éŸ³å£°/hiyoko.mp3"},
    {key:"karasu",name:"ã‹ã‚‰ã™",hint:"ãã‚ãã¦ ã‹ãƒ¼ã‹ãƒ¼ ãªãã‚ˆ",cry:"ã‚«ãƒ¼ã‚«ãƒ¼ï¼",fact:"ã‹ã‚‰ã™ã¯ ã¨ã¦ã‚‚ ã‚ãŸã¾ãŒ ã„ã„ã‚ˆã€‚ã©ã†ãã‚’ ã¤ã‹ã†ã“ã¨ã‚‚ ã§ãã‚‹ã‚“ã ï¼",soundFile:"éŸ³å£°/karasu.mp3"},
    {key:"niwatori",name:"ã«ã‚ã¨ã‚Š",hint:"ãŸã¾ã”ã‚’ ã†ã‚€ã‚ˆï¼",cry:"ã‚³ã‚±ã‚³ãƒƒã‚³ãƒ¼ï¼",fact:"ã«ã‚ã¨ã‚Šã¯ ã‚ã• ã‚³ã‚±ã‚³ãƒƒã‚³ãƒ¼ ã¨ ãªãã‚ˆã€‚ãŸã¾ã”ã‚’ ã†ã‚“ã§ãã‚Œã‚‹ã‚“ã ï¼",soundFile:"éŸ³å£°/niwatori.mp3"},
    {key:"ookami",name:"ãŠãŠã‹ã¿",hint:"ã‚‚ã‚Šã« ã™ã‚“ã§ã„ã¦ ã¤ãã« ã»ãˆã‚‹ã‚ˆ",cry:"ã‚¢ã‚ªãƒ¼ãƒ³ï¼",fact:"ãŠãŠã‹ã¿ã¯ ã‚€ã‚Œã§ ãã‚‰ã™ã‚ˆã€‚ãªã‹ã¾ã¨ ã“ãˆã§ ã¯ãªã—ã™ã‚‹ã‚“ã ï¼",soundFile:"éŸ³å£°/ookami.mp3"},
    {key:"uma",name:"ã†ã¾",hint:"ã²ã²ãƒ¼ã‚“ï¼ã¨ ãªãã‚ˆ",cry:"ãƒ’ãƒ’ãƒ¼ãƒ³ï¼",fact:"ã†ã¾ã¯ ã¯ã—ã‚‹ã®ãŒ ã¨ãã„ï¼1ã«ã¡ã« 60km ã„ã˜ã‚‡ã† ã¯ã—ã‚Œã‚‹ã‚ˆï¼",soundFile:"éŸ³å£°/uma.mp3"},
    {key:"yagi",name:"ã‚„ã",hint:"ã‚‚ã“ã‚‚ã“ã§ ãƒ¡ãƒ¼ã¨ ãªãã‚ˆ",cry:"ãƒ¡ã‚§ãƒ¼ï¼",fact:"ã‚„ãã¯ ã„ã‚ã‚“ãª ã‚‚ã®ã‚’ ãŸã¹ã‚‹ã‚ˆã€‚ã‹ã¿ã®ã‘ãŒ ãµã‚ãµã‚ï¼",soundFile:"éŸ³å£°/yagi.mp3"},
    {key:"ushi",name:"ã†ã—",hint:"ãƒ¢ãƒ¼ã¨ ãªãã‚ˆ",cry:"ãƒ¢ãƒ¼ï¼",fact:"ã†ã—ã¯ ãƒŸãƒ«ã‚¯ã‚„ ãƒã‚¿ãƒ¼ã‚’ ã‚ãŸã—ã¦ãã‚Œã‚‹ã‚ˆã€‚ã®ã‚“ã³ã‚Šã‚„ã•ã‚“ã ã­ï¼",soundFile:"éŸ³å£°/ushi.mp3"},
  ];
  let ROUNDS=5,level=1,score=0,round=0,streak=0,current=null,choices=[],locked=false,usedKeys=[],roundResults=[];
  let selectedKeys=new Set(animals.map(a=>a.key));
  const $=id=>document.getElementById(id);

  window.g1RenderAnimalSelect=function(){
    const cont=$('animalSelect');cont.textContent='';
    animals.forEach(a=>{
      const chip=document.createElement('div');chip.className='animal-chip'+(selectedKeys.has(a.key)?' selected':'');
      const icon=document.createElement('div');icon.className='chip-icon';icon.appendChild(mkImg(a.key));
      const sp=document.createElement('span');sp.textContent=a.name;
      chip.appendChild(icon);chip.appendChild(sp);
      chip.addEventListener('click',()=>{if(selectedKeys.has(a.key))selectedKeys.delete(a.key);else selectedKeys.add(a.key);chip.classList.toggle('selected',selectedKeys.has(a.key));});
      cont.appendChild(chip);
    });
  };
  $('g1SelectAll').addEventListener('click',()=>{animals.forEach(a=>selectedKeys.add(a.key));g1RenderAnimalSelect();});
  $('g1DeselectAll').addEventListener('click',()=>{selectedKeys.clear();g1RenderAnimalSelect();});
  $('animalToggleBtn').addEventListener('click',()=>{const wrap=$('animalSelectWrap'),o=wrap.classList.contains('open');wrap.classList.toggle('open',!o);$('animalToggleBtn').textContent=o?'ğŸ”§ ã§ã¦ãã‚‹ ã©ã†ã¶ã¤ã‚’ ãˆã‚‰ã¶ â–¼':'ğŸ”§ ã¨ã˜ã‚‹ â–²';});

  // Rounds select
  document.querySelectorAll('.btn[data-rd]').forEach(b=>b.addEventListener('click',()=>{const v=Number(b.dataset.rd);ROUNDS=v===0?animals.length:v;document.querySelectorAll('.btn[data-rd]').forEach(x=>x.classList.toggle('active',x===b));}));
  document.querySelectorAll('.btn[data-lv]').forEach(b=>b.addEventListener('click',()=>{level=Number(b.dataset.lv);document.querySelectorAll('.btn[data-lv]').forEach(x=>x.classList.toggle('active',x===b));}));

  function getPool(){return animals.filter(a=>selectedKeys.has(a.key));}

  $('g1StartBtn').addEventListener('click',()=>{
    const pool=getPool();if(pool.length<4){alert('4ã—ã‚…ã‚‹ã„ ã„ã˜ã‚‡ã† ãˆã‚‰ã‚“ã§ã­ï¼');return;}
    if(ROUNDS>pool.length)ROUNDS=pool.length;
    score=0;round=0;streak=0;usedKeys=[];roundResults=[];updateHUD();showScreen('g1GameScreen');nextRound();
  });

  // Cry button
  $('cryBtn').addEventListener('click',()=>{if(current)playCry(current);});

  function nextRound(){
    round++;if(round>ROUNDS){showResult();return;}locked=false;
    $('correctReveal').classList.remove('show');$('correctReveal').textContent='';
    $('feedback').classList.remove('show');$('bigIcon').className='big-icon';
    const pool=getPool();let available=pool.filter(a=>!usedKeys.includes(a.key));if(!available.length)available=[...pool];
    current=available[Math.floor(Math.random()*available.length)];usedKeys.push(current.key);
    const others=shuffle(pool.filter(a=>a.key!==current.key)).slice(0,3);choices=shuffle([current,...others]);
    renderQuestion();updateHUD();
    $('cryBtn').style.display='inline-block';
    if(level===2)speak(current.hint);else speak('ã“ã® ã©ã†ã¶ã¤ã¯ ã ã‚Œã‹ãªï¼Ÿ');
  }
  function updateHUD(){$('roundBadge').textContent='ğŸ¾ '+Math.min(round,ROUNDS)+'/'+ROUNDS;$('scoreBadge').textContent='â­ '+score;$('lvBadge').textContent='Lv'+level;}

  function renderQuestion(){
    const big=$('bigIcon');
    if(level===2){big.textContent='';const q=document.createElement('div');q.style.fontSize='56px';q.textContent='â“';big.appendChild(q);$('promptLabel').textContent='ãƒ’ãƒ³ãƒˆã§ ã‚ã¦ã¦ã­ï¼';$('hintText').textContent=current.hint;}
    else{big.textContent='';big.appendChild(mkImg(current.key));$('promptLabel').textContent='ã“ã® ã©ã†ã¶ã¤ã¯ ãªã«ï¼Ÿ';$('hintText').textContent='ã“ãŸãˆã‚’ ã‚¿ãƒƒãƒ—ã—ã¦ã­';}
    const grid=$('choicesGrid');grid.textContent='';
    choices.forEach(item=>{
      const btn=document.createElement('button');btn.className='choice';btn.type='button';
      const mini=document.createElement('div');mini.className='mini';
      const lab=document.createElement('div');lab.className='c-label';lab.textContent=item.name;
      const snd=document.createElement('button');snd.className='sound-btn';snd.type='button';snd.textContent='ğŸ”Š';
      snd.addEventListener('click',e=>{e.stopPropagation();speak(item.name);});
      if(level===1){mini.appendChild(mkImg(item.key));}else{mini.style.background='#f2f2f7';const sp=document.createElement('span');sp.style.fontSize='24px';sp.textContent='ï¼Ÿ';mini.appendChild(sp);}
      btn.appendChild(mini);btn.appendChild(lab);btn.appendChild(snd);
      btn.addEventListener('click',()=>onAnswer(item,btn));grid.appendChild(btn);
    });
  }

  const STREAK_MSGS={3:'ã™ã”ã„ï¼ğŸ”¥',4:'ã„ã„ã­ï¼âœ¨',5:'ã¦ã‚“ã•ã„ï¼ğŸŒŸ'};
  let streakTimer=null;
  function showStreak(n){const msg=STREAK_MSGS[n];if(!msg)return;const el=$('streakMsg');el.textContent=msg;el.classList.add('show');if(streakTimer)clearTimeout(streakTimer);streakTimer=setTimeout(()=>el.classList.remove('show'),1200);}

  function onAnswer(item,btnEl){
    if(locked)return;const ok=item.key===current.key;locked=true;
    document.querySelectorAll('.choice').forEach(b=>{const isCorrect=b.querySelector('.c-label').textContent===current.name;if(isCorrect)b.classList.add('correct');else if(b===btnEl)b.classList.add('wrong');});
    if(level===2){$('bigIcon').textContent='';$('bigIcon').appendChild(mkImg(current.key));}
    $('cryBtn').style.display='none';
    if(ok){
      score++;streak++;playCorrectSound();
      $('fbCircle').className='fb-circle fb-ok';$('fbCircle').textContent='ğŸ‰';$('fbLabel').textContent='ã™ã”ã„ï¼';
      $('bigIcon').classList.add(streak>=3?'megaBounce':'bounce');
      speak('ã›ã„ã‹ã„ï¼ '+current.name+'ï¼ '+current.cry);
      if(streak>=3)showStreak(streak);
      roundResults.push({correct:true,animal:current});
    }else{
      streak=0;playWrongSound();
      $('fbCircle').className='fb-circle fb-ng';$('fbCircle').textContent='ğŸ’¡';$('fbLabel').textContent='ãŠã—ã„ï¼';
      $('correctReveal').textContent='ã“ãŸãˆã¯ã€Œ'+current.name+'ã€ã ã‚ˆï¼ '+current.cry;$('correctReveal').classList.add('show');
      speak('ãŠã—ã„ï¼ã“ãŸãˆã¯ '+current.name+' ã ã‚ˆã€‚'+current.cry);
      roundResults.push({correct:false,animal:current});
    }
    $('feedback').classList.add('show');updateHUD();
    setTimeout(()=>{$('feedback').classList.remove('show');$('bigIcon').className='big-icon';nextRound();},ok?1500:4000);
  }

  function showResult(){
    showScreen('g1ResultScreen');const pct=Math.round(score/ROUNDS*100);let medal,title;
    if(score===ROUNDS){medal='ğŸ‘‘';title='ãƒ‘ãƒ¼ãƒ•ã‚§ã‚¯ãƒˆï¼ï¼';}
    else if(pct>=80){medal='ğŸ¥‡';title='ã™ã°ã‚‰ã—ã„ï¼';}
    else if(pct>=60){medal='ğŸ¥ˆ';title='ãŒã‚“ã°ã£ãŸã­ï¼';}
    else if(pct>=40){medal='ğŸ¥‰';title='ãŠã—ã„ï¼';}
    else{medal='ğŸ’ª';title='ã¤ãã¯ ãŒã‚“ã°ã‚ã†ï¼';}
    $('resultMedal').textContent=medal;$('resultScore').textContent=score+' / '+ROUNDS;
    $('resultSub').textContent=title;$('resultStars').textContent='â­'.repeat(score)+'â˜†'.repeat(ROUNDS-score);
    let detail='';roundResults.forEach((r,i)=>{detail+=(r.correct?'â­•':'âŒ')+' '+(i+1)+'ã‚‚ã‚“ã‚: '+r.animal.name+'\n';});
    $('resultDetail').textContent=detail;
    if(score===ROUNDS){launchConfetti();speak('ãƒ‘ãƒ¼ãƒ•ã‚§ã‚¯ãƒˆï¼ã™ã”ã„ã­ï¼');}
    else if(pct>=60)speak(score+'ã‚‚ã‚“ ã›ã„ã‹ã„ï¼'+title);else speak(score+'ã‚‚ã‚“ ã›ã„ã‹ã„ã€‚'+title);
  }

  // Zukan
  $('g1ZukanBtn').addEventListener('click',()=>{showScreen('g1BookScreen');renderZukan();});
  $('g1BookBack').addEventListener('click',()=>showScreen('g1ResultScreen'));
  $('g1RetryBtn').addEventListener('click',()=>{showScreen('g1StartScreen');g1RenderAnimalSelect();});
  function renderZukan(){
    const grid=$('zukanGrid');grid.textContent='';
    animals.forEach(a=>{
      const item=document.createElement('div');item.className='zukan-item';
      item.appendChild(mkImg(a.key));
      const nm=document.createElement('div');nm.className='z-name';nm.textContent=a.name;item.appendChild(nm);
      const ft=document.createElement('div');ft.className='z-fact';ft.textContent=a.fact;item.appendChild(ft);
      item.addEventListener('click',()=>speak(a.name+'ã€‚'+a.fact));
      grid.appendChild(item);
    });
  }
})();

// ============================================================
//  Game2: ã©ã†ã¶ã¤åˆ—è»Š
// ============================================================
(function(){
  const ALL_ANIMALS=["inu","neko","kuma","zou","raion","pengin","kirin","hitsuji","buta","koara","hiyoko","karasu","niwatori","ookami","uma","yagi","ushi"];
  const ALL_NAMES={"inu":"ã„ã¬","neko":"ã­ã“","kuma":"ãã¾","zou":"ãã†","raion":"ã‚‰ã„ãŠã‚“","pengin":"ãºã‚“ãã‚“","kirin":"ãã‚Šã‚“","hitsuji":"ã²ã¤ã˜","buta":"ã¶ãŸ","koara":"ã‚³ã‚¢ãƒ©","hiyoko":"ã²ã‚ˆã“","karasu":"ã‹ã‚‰ã™","niwatori":"ã«ã‚ã¨ã‚Š","ookami":"ãŠãŠã‹ã¿","uma":"ã†ã¾","yagi":"ã‚„ã","ushi":"ã†ã—"};
  const STORAGE_KEY="animal_train_v6";
  const VALID_MODES=[2,3,5];
  const TRAIN_COLORS=[
    {c1:'rgba(37,99,235,.18)',c2:'rgba(37,99,235,.06)',label:'rgba(37,99,235,.85)'},
    {c1:'rgba(34,197,94,.22)',c2:'rgba(34,197,94,.08)',label:'rgba(34,197,94,.85)'},
    {c1:'rgba(239,68,68,.20)',c2:'rgba(239,68,68,.06)',label:'rgba(239,68,68,.85)'},
    {c1:'rgba(234,179,8,.25)',c2:'rgba(234,179,8,.08)',label:'rgba(180,140,10,.85)'},
  ];
  function parseMode(v){const n=Number(v);return VALID_MODES.includes(n)?n:5;}
  function safeNum(v,d,lo,hi){const n=Number(v);return isNaN(n)?d:Math.max(lo,Math.min(hi,n));}
  function safeBool(v,d){return v===undefined?d:!!v;}

  let state=loadState();
  let currentCount=1,targetAnimal="inu",trainAnimals=[],isLocked=false;
  let practiceTarget=null,practiceRemaining=0,forcedNextCount=null,lastStationDelta=0;
  let mathBase=0,mathAdd=0;
  let initialized=false;

  const $=id=>document.getElementById(id);
  const trainEl=$('train'),toastEl=$('g2Toast'),confettiEl=$('g2Confetti');
  const barFill=$('g2BarFill'),stampText=$('g2StampText'),levelText=$('g2LevelText'),modeText=$('g2ModeText');
  const hintRange=$('g2HintRange'),hintVoice=$('g2HintVoice'),hintPractice=$('g2HintPractice'),stationText=$('g2StationText');
  const answersEl=$('g2Answers'),animalShelf=$('g2AnimalShelf'),stickerGrid=$('g2StickerGrid');
  const modalBg=$('g2ModalBg'),questionEl=$('g2Question');

  const NUM_WORD={1:"ã„ã¡",2:"ã«",3:"ã•ã‚“",4:"ã‚ˆã‚“",5:"ã”"};
  function speakJA(text){if(!state.voiceOn)return;speak(text);}
  function toast(msg){toastEl.textContent=msg;toastEl.classList.add("show");clearTimeout(toastEl._t);toastEl._t=setTimeout(()=>toastEl.classList.remove("show"),1100);}
  function setButtonsEnabled(on){answersEl.querySelectorAll(".g2-btn").forEach(b=>b.disabled=!on);}
  function clamp(n,lo,hi){return Math.max(lo,Math.min(hi,n));}

  function applyTrainColor(){
    const ci=Math.min(TRAIN_COLORS.length-1,Math.floor((state.level-1)/2));
    const tc=TRAIN_COLORS[ci];
    trainEl.style.setProperty('--train-c1',tc.c1);trainEl.style.setProperty('--train-c2',tc.c2);trainEl.style.setProperty('--train-label',tc.label);
  }

  function updateHUD(){
    barFill.style.width=Math.min(100,(state.stamps%5)/5*100)+"%";
    stampText.textContent=(state.stamps%5)+"/5";levelText.textContent="Lv "+state.level;
    modeText.textContent="ã¯ã‚“ã„: 1ã€œ"+state.ageMode;hintRange.textContent="ï¼ˆ1ã€œ"+getMaxCount()+"ï¼‰";
    hintVoice.textContent="ãƒ»ã“ãˆ: "+(state.voiceOn?"ON":"OFF");hintPractice.textContent="ãƒ»ã‚Œã‚“ã—ã‚…ã†: "+(state.practiceMode?"ON":"OFF");
    if(!state.stationChange)stationText.textContent="ãƒ”ãƒ³ãƒãƒ³ï¼";
    else{if(lastStationDelta===1)stationText.textContent="+1 ã®ã£ãŸï¼";else if(lastStationDelta===-1)stationText.textContent="-1 ãŠã‚ŠãŸï¼";else stationText.textContent="ãƒ”ãƒ³ãƒãƒ³ï¼";}
    renderAnswerButtons();renderBook();applyTrainColor();
  }
  function renderAnswerButtons(){
    answersEl.textContent='';const max=Math.max(currentCount||1,state.mathMode?getMaxCount()*2:getMaxCount());const realMax=Math.min(max,10);
    const cols=realMax<=3?realMax:5;answersEl.style.gridTemplateColumns="repeat("+cols+",1fr)";
    for(let n=1;n<=realMax;n++){const btn=document.createElement("button");btn.className="g2-btn";btn.textContent=String(n);btn.addEventListener("pointerdown",()=>onAnswer(n),{passive:true});answersEl.appendChild(btn);}
  }
  function renderBook(){
    animalShelf.textContent='';ALL_ANIMALS.slice(0,state.unlockedCount).forEach(a=>{
      const s=document.createElement("span");s.className="g2-chip";s.appendChild(mkImg(a));
      const t=document.createTextNode(' '+(ALL_NAMES[a]||a));s.appendChild(t);animalShelf.appendChild(s);
    });
    stickerGrid.textContent='';const page=state.stickers%10;
    for(let i=0;i<10;i++){const slot=document.createElement("div");slot.className="g2-slot";slot.textContent=i<page?"â­":"";stickerGrid.appendChild(slot);}
  }
  function confettiBurst(){if(!state.fancyRewards)return;confettiEl.textContent='';for(let i=0;i<26;i++){const p=document.createElement("i");p.style.left=Math.random()*100+"vw";p.style.animationDuration=(850+Math.random()*450)+"ms";p.style.width=(8+Math.floor(Math.random()*10))+"px";p.style.height=(10+Math.floor(Math.random()*14))+"px";p.style.background="hsl("+Math.floor(Math.random()*360)+" 85% 60%)";confettiEl.appendChild(p);}setTimeout(()=>{confettiEl.textContent='';},1200);}

  function buildTrain(animals){
    trainEl.textContent='';
    const engine=document.createElement("div");engine.className="engine";
    const lbl=document.createElement("div");lbl.className="label";lbl.textContent="TRAIN";engine.appendChild(lbl);
    for(let w=0;w<3;w++){const wh=document.createElement("div");wh.className="wheel w"+(w+1);engine.appendChild(wh);}
    trainEl.appendChild(engine);
    animals.forEach((a,idx)=>{
      const car=document.createElement("div");car.className="car";
      for(let w=0;w<3;w++){const wh=document.createElement("div");wh.className="wheel w"+(w+1);car.appendChild(wh);}
      const an=document.createElement("div");an.className="animal";an.setAttribute("role","button");an.appendChild(mkImg(a));
      an.addEventListener("pointerdown",()=>{an.classList.remove("tap");void an.offsetWidth;an.classList.add("tap");speakJA(String(idx+1));},{passive:true});
      car.appendChild(an);trainEl.appendChild(car);
    });
  }
  function animateTrainIn(){playTrainDepart();trainEl.style.transition="none";trainEl.style.transform="translateX(-40%)";void trainEl.offsetWidth;trainEl.style.transition="transform 900ms cubic-bezier(.2,.9,.2,1)";trainEl.style.transform="translateX(4%)";}
  function animateTrainOut(cb){playTrainBrake();trainEl.style.transition="transform 650ms cubic-bezier(.2,.9,.2,1)";trainEl.style.transform="translateX(120%)";setTimeout(cb,700);}

  function pickAnimal(){const pool=ALL_ANIMALS.slice(0,state.unlockedCount);return pool[Math.floor(Math.random()*pool.length)];}
  function getMaxCount(){const m=state.ageMode;if(state.autoEase&&state.missStreak>=2)return Math.max(2,Math.floor(m/2));return m;}
  function pickCount(){return 1+Math.floor(Math.random()*getMaxCount());}

  function newRound(){
    if(state.practiceMode){if(practiceRemaining<=0||practiceTarget==null){practiceTarget=pickCount();practiceRemaining=3;}currentCount=practiceTarget;practiceRemaining--;}
    else{practiceTarget=null;practiceRemaining=0;if(forcedNextCount!=null){currentCount=forcedNextCount;forcedNextCount=null;}else{currentCount=pickCount();}}

    targetAnimal=pickAnimal();
    // B1: mix animals
    const pool=ALL_ANIMALS.slice(0,state.unlockedCount);
    const otherPool=pool.filter(a=>a!==targetAnimal);
    const totalCars=Math.min(currentCount+Math.floor(Math.random()*2),getMaxCount());
    trainAnimals=[];
    for(let i=0;i<currentCount;i++)trainAnimals.push(targetAnimal);
    for(let i=currentCount;i<totalCars;i++)trainAnimals.push(otherPool.length?otherPool[Math.floor(Math.random()*otherPool.length)]:targetAnimal);
    trainAnimals=shuffle(trainAnimals);

    if(state.mathMode){
      mathBase=Math.max(1,Math.floor(currentCount*0.6));mathAdd=currentCount-mathBase;
      questionEl.textContent=mathBase+'ã²ã ã®ã£ã¦ã¦ '+mathAdd+'ã²ã ã®ã£ãŸã‚ˆã€‚ãœã‚“ã¶ã§ï¼Ÿ';
      const firstBatch=trainAnimals.slice(0,mathBase);
      buildTrain(firstBatch);animateTrainIn();
      setButtonsEnabled(false);isLocked=true;
      setTimeout(()=>{buildTrain(trainAnimals);animateTrainIn();
        speakJA(mathAdd+'ã²ã ã®ã£ãŸã‚ˆã€‚ãœã‚“ã¶ã§ ã„ãã¤ï¼Ÿ');
        if(state.speedMode){setTimeout(()=>{animateTrainOut(()=>{setButtonsEnabled(true);isLocked=false;});},2500);}
        else{setButtonsEnabled(true);isLocked=false;}
      },2000);
    }else{
      questionEl.textContent=(totalCars>currentCount)?(ALL_NAMES[targetAnimal]||targetAnimal)+'ã¯ ãªã‚“ã³ãï¼Ÿ':'ã„ãã¤ï¼Ÿ';
      buildTrain(trainAnimals);animateTrainIn();
      if(state.speedMode){setButtonsEnabled(false);isLocked=true;
        setTimeout(()=>{animateTrainOut(()=>{setButtonsEnabled(true);isLocked=false;});},2500);
      }else{setButtonsEnabled(true);isLocked=false;}
    }
    updateHUD();
  }

  function correct(){
    toast("ãƒ”ãƒ³ãƒãƒ³ï¼ğŸ‰");speakJA("ã›ã„ã‹ã„ï¼");if(state.fancyRewards)confettiBurst();
    state.stamps+=1;state.stickers+=1;state.totalCorrect=(state.totalCorrect||0)+1;state.streak=(state.streak||0)+1;state.missStreak=0;
    if(state.totalCorrect%10===0){state.level=Math.min(9,state.level+1);toast("ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—ï¼ Lv"+state.level+" âœ¨");speakJA("ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—ï¼");if(state.fancyRewards)confettiBurst();}
    if(state.stamps%5===0){state.unlockedCount=Math.min(ALL_ANIMALS.length,state.unlockedCount+1);toast("ã‚ãŸã‚‰ã—ã„ ã©ã†ã¶ã¤ï¼ğŸ§¡");speakJA("ã‚ãŸã‚‰ã—ã„ã©ã†ã¶ã¤ï¼");if(state.fancyRewards)confettiBurst();}
    if(!state.practiceMode){lastStationDelta=0;forcedNextCount=null;if(state.stationChange){const max=getMaxCount(),deltas=[];if(currentCount-1>=1)deltas.push(-1);if(currentCount+1<=max)deltas.push(1);if(deltas.length){const d=deltas[Math.floor(Math.random()*deltas.length)];lastStationDelta=d;forcedNextCount=clamp(currentCount+d,1,max);}}}
    else{lastStationDelta=0;forcedNextCount=null;}
    saveState(state);updateHUD();isLocked=true;setButtonsEnabled(false);animateTrainOut(()=>newRound());
  }
  function wrong(){
    toast("ãŠã—ã„ï¼ã‚‚ã†ã„ã£ã‹ã„ ğŸ˜Š");speakJA("ãŠã—ã„ã€‚");state.streak=0;state.missStreak=(state.missStreak||0)+1;
    if(state.practiceMode)practiceRemaining=Math.min(3,practiceRemaining+1);
    saveState(state);updateHUD();isLocked=true;setButtonsEnabled(false);
    animateTrainOut(()=>{buildTrain(trainAnimals);animateTrainIn();setTimeout(()=>{setButtonsEnabled(true);isLocked=false;},250);});
  }
  function onAnswer(n){if(isLocked)return;speakJA(NUM_WORD[n]||String(n));(n===currentCount)?correct():wrong();}
  async function countAll(){if(isLocked)return;const target=trainAnimals.filter(a=>a===targetAnimal).length;for(let i=1;i<=target;i++){speakJA(String(i));await new Promise(r=>setTimeout(r,420));}}

  $('g2SpeakBtn').addEventListener("click",()=>speakJA("ã„ãã¤ï¼Ÿ"));
  $('g2CountAllBtn').addEventListener("click",countAll);
  $('g2ResetBtn').addEventListener("click",()=>{if(!confirm("ãƒªã‚»ãƒƒãƒˆã™ã‚‹ï¼Ÿ"))return;localStorage.removeItem(STORAGE_KEY);location.reload();});

  $('g2OpenSettings').addEventListener("click",()=>{
    $('g2AgeMode').value=String(state.ageMode);$('g2VoiceOn').checked=!!state.voiceOn;$('g2AutoEase').checked=!!state.autoEase;
    $('g2PracticeMode').checked=!!state.practiceMode;$('g2StationChange').checked=!!state.stationChange;
    $('g2FancyRewards').checked=!!state.fancyRewards;$('g2MathMode').checked=!!state.mathMode;$('g2SpeedMode').checked=!!state.speedMode;
    modalBg.classList.add("show");
  });
  $('g2CloseSettings').addEventListener("click",()=>modalBg.classList.remove("show"));
  modalBg.addEventListener("click",e=>{if(e.target===modalBg)modalBg.classList.remove("show");});
  $('g2ApplySettings').addEventListener("click",()=>{
    state.ageMode=parseMode($('g2AgeMode').value);state.voiceOn=!!$('g2VoiceOn').checked;state.autoEase=!!$('g2AutoEase').checked;
    state.practiceMode=!!$('g2PracticeMode').checked;state.stationChange=!!$('g2StationChange').checked;state.fancyRewards=!!$('g2FancyRewards').checked;
    state.mathMode=!!$('g2MathMode').checked;state.speedMode=!!$('g2SpeedMode').checked;
    state.missStreak=0;lastStationDelta=0;forcedNextCount=null;practiceTarget=null;practiceRemaining=0;
    saveState(state);updateHUD();modalBg.classList.remove("show");toast("OKï¼");speakJA("ã‚ªãƒ¼ã‚±ãƒ¼ï¼");
    isLocked=true;setButtonsEnabled(false);animateTrainOut(()=>newRound());
  });

  function loadState(){try{const raw=localStorage.getItem(STORAGE_KEY);if(raw){const s=JSON.parse(raw);return{stamps:safeNum(s.stamps,0,0,9999),stickers:safeNum(s.stickers,0,0,9999),unlockedCount:safeNum(s.unlockedCount,3,3,ALL_ANIMALS.length),level:safeNum(s.level,1,1,9),totalCorrect:safeNum(s.totalCorrect,0,0,99999),ageMode:parseMode(s.ageMode),voiceOn:safeBool(s.voiceOn,true),autoEase:safeBool(s.autoEase,true),practiceMode:safeBool(s.practiceMode,false),stationChange:safeBool(s.stationChange,true),fancyRewards:safeBool(s.fancyRewards,true),mathMode:safeBool(s.mathMode,false),speedMode:safeBool(s.speedMode,false),streak:safeNum(s.streak,0,0,999),missStreak:safeNum(s.missStreak,0,0,999)};}}catch(e){}
  return{stamps:0,stickers:0,unlockedCount:3,level:1,totalCorrect:0,ageMode:5,voiceOn:true,autoEase:true,practiceMode:false,stationChange:true,fancyRewards:true,mathMode:false,speedMode:false,streak:0,missStreak:0};}
  function saveState(s){try{localStorage.setItem(STORAGE_KEY,JSON.stringify(s));}catch(e){}}

  window.g2Init=function(){if(!initialized){initialized=true;updateHUD();newRound();}};
  window.g2Stop=function(){isLocked=true;};
})();

// ============================================================
//  Game3: ã²ã‚‰ãŒãª ãŠã¼ãˆã‚ˆã†
// ============================================================
(function(){
  const BASIC=[
    {h:'ã‚',r:'A',word:'ã‚ã‚Š',emoji:'ğŸœ'},{h:'ã„',r:'I',word:'ã„ã¬',emoji:'ğŸ•'},{h:'ã†',r:'U',word:'ã†ã¿',emoji:'ğŸŒŠ'},{h:'ãˆ',r:'E',word:'ãˆã',emoji:'ğŸš‰'},{h:'ãŠ',r:'O',word:'ãŠã«',emoji:'ğŸ‘¹'},
    {h:'ã‹',r:'KA',word:'ã‹ã«',emoji:'ğŸ¦€'},{h:'ã',r:'KI',word:'ãã¤ã­',emoji:'ğŸ¦Š'},{h:'ã',r:'KU',word:'ãã‚‚',emoji:'â˜ï¸'},{h:'ã‘',r:'KE',word:'ã‘ã‚€ã—',emoji:'ğŸ›'},{h:'ã“',r:'KO',word:'ã“ã„',emoji:'ğŸŸ'},
    {h:'ã•',r:'SA',word:'ã•ã‹ãª',emoji:'ğŸ '},{h:'ã—',r:'SHI',word:'ã—ã¾ã†ã¾',emoji:'ğŸ¦“'},{h:'ã™',r:'SU',word:'ã™ã„ã‹',emoji:'ğŸ‰'},{h:'ã›',r:'SE',word:'ã›ã¿',emoji:'ğŸ¦Ÿ'},{h:'ã',r:'SO',word:'ãã‚‰',emoji:'ğŸŒ¤'},
    {h:'ãŸ',r:'TA',word:'ãŸã“',emoji:'ğŸ™'},{h:'ã¡',r:'CHI',word:'ã¡ã‚‡ã†',emoji:'ğŸ¦‹'},{h:'ã¤',r:'TSU',word:'ã¤ã',emoji:'ğŸŒ™'},{h:'ã¦',r:'TE',word:'ã¦ã‚“ã—',emoji:'ğŸ‘¼'},{h:'ã¨',r:'TO',word:'ã¨ã‚Š',emoji:'ğŸ¦'},
    {h:'ãª',r:'NA',word:'ãªã™',emoji:'ğŸ†'},{h:'ã«',r:'NI',word:'ã«ã˜',emoji:'ğŸŒˆ'},{h:'ã¬',r:'NU',word:'ã¬ã„ãã‚‹ã¿',emoji:'ğŸ§¸'},{h:'ã­',r:'NE',word:'ã­ã“',emoji:'ğŸ±'},{h:'ã®',r:'NO',word:'ã®ã‚Š',emoji:'ğŸŒ¿'},
    {h:'ã¯',r:'HA',word:'ã¯ãª',emoji:'ğŸŒ¸'},{h:'ã²',r:'HI',word:'ã²ã‚ˆã“',emoji:'ğŸ¥'},{h:'ãµ',r:'FU',word:'ãµã­',emoji:'â›µ'},{h:'ã¸',r:'HE',word:'ã¸ã³',emoji:'ğŸ'},{h:'ã»',r:'HO',word:'ã»ã—',emoji:'â­'},
    {h:'ã¾',r:'MA',word:'ã¾ã‚',emoji:'ğŸ«˜'},{h:'ã¿',r:'MI',word:'ã¿ã‹ã‚“',emoji:'ğŸŠ'},{h:'ã‚€',r:'MU',word:'ã‚€ã—',emoji:'ğŸ'},{h:'ã‚',r:'ME',word:'ã‚ã ã‹',emoji:'ğŸŸ'},{h:'ã‚‚',r:'MO',word:'ã‚‚ã‚‚',emoji:'ğŸ‘'},
    {h:'ã‚„',r:'YA',word:'ã‚„ã',emoji:'ğŸ'},{h:'ã‚†',r:'YU',word:'ã‚†ã',emoji:'â„ï¸'},{h:'ã‚ˆ',r:'YO',word:'ã‚ˆã‚‹',emoji:'ğŸŒƒ'},
    {h:'ã‚‰',r:'RA',word:'ã‚‰ã„ãŠã‚“',emoji:'ğŸ¦'},{h:'ã‚Š',r:'RI',word:'ã‚Šã‚“ã”',emoji:'ğŸ'},{h:'ã‚‹',r:'RU',word:'ã‚‹ã³ãƒ¼',emoji:'ğŸ’'},{h:'ã‚Œ',r:'RE',word:'ã‚Œã‚‚ã‚“',emoji:'ğŸ‹'},{h:'ã‚',r:'RO',word:'ã‚ã¼ã£ã¨',emoji:'ğŸ¤–'},
    {h:'ã‚',r:'WA',word:'ã‚ã«',emoji:'ğŸŠ'},{h:'ã‚’',r:'WO',word:'ã‚’ã‹',emoji:'ğŸ”'},{h:'ã‚“',r:'N',word:'ã‚“ã€œï¼Ÿ',emoji:'ğŸ¤”'},
  ];
  const DAKUTEN=[
    {h:'ãŒ',r:'GA',word:'ãŒã£ã“ã†',emoji:'ğŸ«'},{h:'ã',r:'GI',word:'ãã‚…ã†ã«ã‚…ã†',emoji:'ğŸ¥›'},{h:'ã',r:'GU',word:'ãã‚‚',emoji:'ğŸ•·'},{h:'ã’',r:'GE',word:'ã’ã‚“ã',emoji:'ğŸ’ª'},{h:'ã”',r:'GO',word:'ã”ã¯ã‚“',emoji:'ğŸš'},
    {h:'ã–',r:'ZA',word:'ã–ã‚ŠãŒã«',emoji:'ğŸ¦'},{h:'ã˜',r:'JI',word:'ã˜ã¦ã‚“ã—ã‚ƒ',emoji:'ğŸš²'},{h:'ãš',r:'ZU',word:'ãšã¼ã‚“',emoji:'ğŸ‘–'},{h:'ãœ',r:'ZE',word:'ãœã‚Šãƒ¼',emoji:'ğŸ®'},{h:'ã',r:'ZO',word:'ãã†',emoji:'ğŸ˜'},
    {h:'ã ',r:'DA',word:'ã ã‚“ã”',emoji:'ğŸ¡'},{h:'ã¢',r:'DI',word:'ã¢ã‚ã‚“',emoji:'ğŸŒ'},{h:'ã¥',r:'DU',word:'ã¥ã¤ã¿',emoji:'ğŸ“¦'},{h:'ã§',r:'DE',word:'ã§ã‚“ã—ã‚ƒ',emoji:'ğŸšƒ'},{h:'ã©',r:'DO',word:'ã©ã†ã¶ã¤',emoji:'ğŸ¾'},
    {h:'ã°',r:'BA',word:'ã°ãªãª',emoji:'ğŸŒ'},{h:'ã³',r:'BI',word:'ã³ã£ãã‚Š',emoji:'ğŸ˜²'},{h:'ã¶',r:'BU',word:'ã¶ã©ã†',emoji:'ğŸ‡'},{h:'ã¹',r:'BE',word:'ã¹ã‚“ã¨ã†',emoji:'ğŸ±'},{h:'ã¼',r:'BO',word:'ã¼ã†ã—',emoji:'ğŸ©'},
    {h:'ã±',r:'PA',word:'ã±ã‚“ã ',emoji:'ğŸ¼'},{h:'ã´',r:'PI',word:'ã´ã‚ã®',emoji:'ğŸ¹'},{h:'ã·',r:'PU',word:'ã·ã‚Šã‚“',emoji:'ğŸ®'},{h:'ãº',r:'PE',word:'ãºã‚“ãã‚“',emoji:'ğŸ§'},{h:'ã½',r:'PO',word:'ã½ã™ã¨',emoji:'ğŸ“®'},
  ];
  const KATAKANA=[
    {h:'ã‚¢',r:'A',word:'ã‚¢ã‚¤ã‚¹',emoji:'ğŸ¦'},{h:'ã‚¤',r:'I',word:'ã‚¤ãƒ«ã‚«',emoji:'ğŸ¬'},{h:'ã‚¦',r:'U',word:'ã‚¦ã‚µã‚®',emoji:'ğŸ°'},{h:'ã‚¨',r:'E',word:'ã‚¨ãƒ“',emoji:'ğŸ¦'},{h:'ã‚ª',r:'O',word:'ã‚ªãƒ¬ãƒ³ã‚¸',emoji:'ğŸŠ'},
    {h:'ã‚«',r:'KA',word:'ã‚«ãƒ¡ãƒ©',emoji:'ğŸ“·'},{h:'ã‚­',r:'KI',word:'ã‚­ãƒªãƒ³',emoji:'ğŸ¦’'},{h:'ã‚¯',r:'KU',word:'ã‚¯ã‚¸ãƒ©',emoji:'ğŸ³'},{h:'ã‚±',r:'KE',word:'ã‚±ãƒ¼ã‚­',emoji:'ğŸ‚'},{h:'ã‚³',r:'KO',word:'ã‚³ã‚¢ãƒ©',emoji:'ğŸ¨'},
    {h:'ã‚µ',r:'SA',word:'ã‚µãƒƒã‚«ãƒ¼',emoji:'âš½'},{h:'ã‚·',r:'SHI',word:'ã‚·ãƒã‚¦ãƒ',emoji:'ğŸ¦“'},{h:'ã‚¹',r:'SU',word:'ã‚¹ã‚¤ã‚«',emoji:'ğŸ‰'},{h:'ã‚»',r:'SE',word:'ã‚»ãƒŸ',emoji:'ğŸ¦—'},{h:'ã‚½',r:'SO',word:'ã‚½ãƒ•ãƒˆ',emoji:'ğŸ¦'},
    {h:'ã‚¿',r:'TA',word:'ã‚¿ã‚³',emoji:'ğŸ™'},{h:'ãƒ',r:'CHI',word:'ãƒãƒ¼ã‚º',emoji:'ğŸ§€'},{h:'ãƒ„',r:'TSU',word:'ãƒ„ãƒãƒ¡',emoji:'ğŸ¦'},{h:'ãƒ†',r:'TE',word:'ãƒ†ãƒ¬ãƒ“',emoji:'ğŸ“º'},{h:'ãƒˆ',r:'TO',word:'ãƒˆãƒãƒˆ',emoji:'ğŸ…'},
    {h:'ãƒŠ',r:'NA',word:'ãƒŠã‚¹',emoji:'ğŸ†'},{h:'ãƒ‹',r:'NI',word:'ãƒ‹ãƒ³ã‚¸ãƒ³',emoji:'ğŸ¥•'},{h:'ãƒŒ',r:'NU',word:'ãƒŒãƒ¼ãƒ‰ãƒ«',emoji:'ğŸœ'},{h:'ãƒ',r:'NE',word:'ãƒã‚³',emoji:'ğŸ±'},{h:'ãƒ',r:'NO',word:'ãƒãƒ¼ãƒˆ',emoji:'ğŸ“’'},
    {h:'ãƒ',r:'HA',word:'ãƒãƒ',emoji:'ğŸ'},{h:'ãƒ’',r:'HI',word:'ãƒ’ãƒ¨ã‚³',emoji:'ğŸ¥'},{h:'ãƒ•',r:'FU',word:'ãƒ•ã‚¯ãƒ­ã‚¦',emoji:'ğŸ¦‰'},{h:'ãƒ˜',r:'HE',word:'ãƒ˜ãƒ“',emoji:'ğŸ'},{h:'ãƒ›',r:'HO',word:'ãƒ›ã‚·',emoji:'â­'},
    {h:'ãƒ',r:'MA',word:'ãƒã‚°ãƒ­',emoji:'ğŸŸ'},{h:'ãƒŸ',r:'MI',word:'ãƒŸã‚«ãƒ³',emoji:'ğŸŠ'},{h:'ãƒ ',r:'MU',word:'ãƒ ã‚·',emoji:'ğŸ'},{h:'ãƒ¡',r:'ME',word:'ãƒ¡ãƒ­ãƒ³',emoji:'ğŸˆ'},{h:'ãƒ¢',r:'MO',word:'ãƒ¢ãƒ¢',emoji:'ğŸ‘'},
    {h:'ãƒ¤',r:'YA',word:'ãƒ¤ã‚®',emoji:'ğŸ'},{h:'ãƒ¦',r:'YU',word:'ãƒ¦ã‚­',emoji:'â„ï¸'},{h:'ãƒ¨',r:'YO',word:'ãƒ¨ãƒƒãƒˆ',emoji:'â›µ'},
    {h:'ãƒ©',r:'RA',word:'ãƒ©ã‚¤ã‚ªãƒ³',emoji:'ğŸ¦'},{h:'ãƒª',r:'RI',word:'ãƒªãƒ³ã‚´',emoji:'ğŸ'},{h:'ãƒ«',r:'RU',word:'ãƒ«ãƒ“ãƒ¼',emoji:'ğŸ’'},{h:'ãƒ¬',r:'RE',word:'ãƒ¬ãƒ¢ãƒ³',emoji:'ğŸ‹'},{h:'ãƒ­',r:'RO',word:'ãƒ­ãƒœãƒƒãƒˆ',emoji:'ğŸ¤–'},
    {h:'ãƒ¯',r:'WA',word:'ãƒ¯ãƒ‹',emoji:'ğŸŠ'},{h:'ãƒ²',r:'WO',word:'ãƒ²',emoji:'ğŸ“'},{h:'ãƒ³',r:'N',word:'ãƒ³ï¼Ÿ',emoji:'ğŸ¤”'},
  ];
  const WORDS=['ã•ãã‚‰','ã‚Šã‚“ã”','ã™ã„ã‹','ãã¤ã­','ã­ã“','ã„ã¬','ã†ã•ã','ã‹ã‚','ã¨ã‚Š','ã¯ãª','ãã‚‚','ãã‚‰','ã»ã—','ã¤ã','ã‚„ã¾','ã‹ã«','ãŸã“','ã†ã¿'];

  const STATS_KEY='hiragana_stats_v1';
  let stats=loadStats();
  function loadStats(){try{const r=localStorage.getItem(STATS_KEY);if(r){const d=JSON.parse(r);if(d&&typeof d==='object')return d;}}catch(e){}return {};}
  function saveStats(){try{localStorage.setItem(STATS_KEY,JSON.stringify(stats));}catch(e){}}
  function recordAnswer(ch,ok){if(!stats[ch])stats[ch]={c:0,t:0};stats[ch].t++;if(ok)stats[ch].c++;saveStats();}
  function getRate(ch){const s=stats[ch];if(!s||s.t===0)return -1;return Math.round(s.c/s.t*100);}

  const $=id=>document.getElementById(id);
  let charSet='basic',curData=BASIC,idx=0,mode='flash',seen=new Set(),qScore=0,qAnswered=false,wScore=0,initialized=false,quizTotal=10,quizCount=0,wrongList=[],wrongOnlyMode=false;

  function getData(){if(charSet==='dakuten')return DAKUTEN;if(charSet==='katakana')return KATAKANA;return BASIC;}

  // Char set buttons
  document.querySelectorAll('#g3CharRow .g3-charBtn').forEach(b=>b.addEventListener('click',()=>{
    charSet=b.dataset.set;curData=getData();idx=0;seen.clear();
    document.querySelectorAll('#g3CharRow .g3-charBtn').forEach(x=>x.classList.toggle('active',x===b));
    if(mode==='flash')updateCard();else if(mode==='quiz'){qScore=0;quizCount=0;wrongList=[];wrongOnlyMode=false;$('g3WrongOnlyBtn').classList.remove('active');$('g3WrongOnlyBtn').textContent='âŒ ã¾ã¡ãŒã„ã®ã¿';$('g3QuizMain').style.display='';$('g3QuizResult').style.display='none';genQuiz();}else if(mode==='word'){wScore=0;genWord();}else if(mode==='stats')renderStats();
  }));

  // Mode buttons
  document.querySelectorAll('#g3ModeRow .g3-modeBtn').forEach(b=>b.addEventListener('click',()=>{
    mode=b.dataset.mode;
    document.querySelectorAll('#g3ModeRow .g3-modeBtn').forEach(x=>x.classList.toggle('active',x===b));
    $('g3Flash').style.display=mode==='flash'?'block':'none';
    $('g3Quiz').style.display=mode==='quiz'?'block':'none';
    document.querySelectorAll('#g3Word')[0].style.display=mode==='word'?'block':'none';
    $('g3Stats').style.display=mode==='stats'?'block':'none';
    if(mode==='flash')updateCard();
    if(mode==='quiz'){qScore=0;quizCount=0;wrongList=[];wrongOnlyMode=false;$('g3WrongOnlyBtn').classList.remove('active');$('g3WrongOnlyBtn').textContent='âŒ ã¾ã¡ãŒã„ã®ã¿';$('g3QuizMain').style.display='';$('g3QuizResult').style.display='none';$('g3Score').textContent='â­ 0 / '+quizTotal+'ã‚‚ã‚“';genQuiz();}
    if(mode==='word'){wScore=0;$('g3WScore').textContent='â­ 0 ã‚‚ã‚“ ã›ã„ã‹ã„ï¼';genWord();}
    if(mode==='stats')renderStats();
  }));

  function updateCard(){
    const it=curData[idx];seen.add(idx);
    $('g3Emoji').textContent=it.emoji;$('g3Hira').textContent=it.h;$('g3Romaji').textContent=it.r;
    // fix: use the non-id g3Word for flashcard
    $('g3Card').querySelectorAll('.g3-word')[0].textContent=it.word;
    $('g3Prog').textContent=(idx+1)+' / '+curData.length;
    const rate=getRate(it.h);const rb=$('g3Rate');
    if(rate>=0){rb.style.display='inline-block';rb.textContent=rate+'% ã›ã„ã‹ã„';rb.style.background=rate>=80?'var(--ok)':rate>=50?'var(--ng)':'var(--accent)';}else{rb.style.display='none';}
    $('g3Card').style.animation='none';$('g3Card').offsetHeight;$('g3Card').style.animation='';
    buildDots();
  }
  function buildDots(){const row=$('g3Dots');row.textContent='';curData.forEach((_,i)=>{const d=document.createElement('div');d.className='g3-dot'+(seen.has(i)?' seen':'')+(i===idx?' current':'');row.appendChild(d);});}
  function speakCard(){const it=curData[idx];speak(it.h+'ã€'+it.word);}

  $('g3Card').addEventListener('click',speakCard);
  $('g3Prev').addEventListener('click',()=>{idx=(idx-1+curData.length)%curData.length;updateCard();speakCard();});
  $('g3Next').addEventListener('click',()=>{idx=(idx+1)%curData.length;updateCard();speakCard();});

  function resetQuiz(wo){wrongOnlyMode=!!wo;$('g3WrongOnlyBtn').classList.toggle('active',wrongOnlyMode);$('g3WrongOnlyBtn').textContent=wrongOnlyMode?'âœ… ã¾ã¡ãŒã„ã®ã¿':'âŒ ã¾ã¡ãŒã„ã®ã¿';qScore=0;quizCount=0;$('g3QuizMain').style.display='';$('g3QuizResult').style.display='none';genQuiz();}
  document.querySelectorAll('.g3-qTotalBtn').forEach(b=>b.addEventListener('click',()=>{quizTotal=Number(b.dataset.total);document.querySelectorAll('.g3-qTotalBtn').forEach(x=>x.classList.toggle('active',x===b));if(mode==='quiz'&&(quizCount===0||quizCount>=quizTotal))resetQuiz(wrongOnlyMode);}));
  $('g3WrongOnlyBtn').addEventListener('click',()=>{if(!wrongOnlyMode&&wrongList.length<4){speak('ã¾ã¡ãŒã„ãŒ ãŸã‚Šãªã„ã‚ˆ');return;}resetQuiz(!wrongOnlyMode);});
  $('g3QuizRetry').addEventListener('click',()=>resetQuiz(false));
  $('g3QuizRetryWrong').addEventListener('click',()=>resetQuiz(true));

  function showQuizResult(){$('g3QuizMain').style.display='none';$('g3QuizResult').style.display='';const pct=Math.round(qScore/quizTotal*100);$('g3QuizResultScore').textContent='ğŸ‰ '+qScore+' / '+quizTotal+'ã‚‚ã‚“ ã›ã„ã‹ã„ï¼ï¼ˆ'+pct+'%ï¼‰';$('g3Score').textContent='â­ '+qScore+' / '+quizTotal+'ã‚‚ã‚“';$('g3QuizRetryWrong').style.display=wrongList.length>=4?'inline-block':'none';if(pct===100)speak('ãƒ‘ãƒ¼ãƒ•ã‚§ã‚¯ãƒˆï¼ã™ã”ã„ã­ï¼');else speak(qScore+'ã‚‚ã‚“ ã›ã„ã‹ã„ï¼');}

  // Quiz
  function genQuiz(){
    if(quizCount>=quizTotal){showQuizResult();return;}
    qAnswered=false;
    const pool=wrongOnlyMode?wrongList:curData;
    if(pool.length<1){$('g3QText').textContent='ã‚‚ã‚“ã ã„ãŒ ãªã„ã‚ˆï¼';$('g3Opts').textContent='';return;}
    $('g3QuizMain').style.display='';$('g3QuizResult').style.display='none';
    // æ­£è§£ã‚’é¸ã¶
    let ci;
    if(!wrongOnlyMode){const weak=pool.map((it,i)=>({i,rate:getRate(it.h)})).filter(x=>x.rate>=0&&x.rate<70);ci=(weak.length>0&&Math.random()<0.6)?weak[Math.floor(Math.random()*weak.length)].i:Math.floor(Math.random()*pool.length);}
    else{ci=Math.floor(Math.random()*pool.length);}
    const correct=pool[ci];
    // ä¸æ­£è§£ã®é¸æŠè‚¢ã¯curDataã‹ã‚‰å–ã‚‹
    const wrongPool=curData.filter(x=>x.h!==correct.h);
    const wrongs=shuffle(wrongPool).slice(0,3);
    const shuffledOpts=shuffle([correct,...wrongs]);
    $('g3QEmoji').textContent=correct.emoji;$('g3QText').textContent='ã€Œ'+correct.word+'ã€ã® ã•ã„ã—ã‚‡ã® ã‚‚ã˜ã¯ ã©ã‚Œï¼Ÿ';
    $('g3Score').textContent='â­ '+qScore+' / '+quizTotal+'ã‚‚ã‚“ã€€'+(quizCount+1)+'ã‚‚ã‚“ç›®';
    const cont=$('g3Opts');cont.textContent='';
    shuffledOpts.forEach(item=>{
      const btn=document.createElement('button');btn.className='g3-opt';btn.textContent=item.h;
      btn.addEventListener('click',()=>{
        if(qAnswered)return;qAnswered=true;quizCount++;
        const ok=item.h===correct.h;
        recordAnswer(correct.h,ok);
        if(ok){btn.classList.add('correct');qScore++;$('g3Score').textContent='â­ '+qScore+' / '+quizTotal+'ã‚‚ã‚“ã€€'+quizCount+'ã‚‚ã‚“ç›®';showCeleb('ğŸ‰ ã›ã„ã‹ã„ï¼');playCorrectSound();speak('ã‚„ã£ãŸãƒ¼ï¼ã›ã„ã‹ã„ï¼');}
        else{btn.classList.add('wrong');cont.querySelectorAll('.g3-opt').forEach(b=>{if(b.textContent===correct.h)b.classList.add('correct');});if(!wrongOnlyMode&&!wrongList.some(x=>x.h===correct.h))wrongList.push(correct);playWrongSound();speak('ã–ã‚“ã­ã‚“ï¼ã€Œ'+correct.h+'ã€ã ã‚ˆï¼');}
        setTimeout(genQuiz,2000);
      });
      cont.appendChild(btn);
    });
    speak('ã€Œ'+correct.word+'ã€ã® ã•ã„ã—ã‚‡ã® ã‚‚ã˜ã¯ï¼Ÿ');
  }

  // Word game
  function genWord(){
    const word=WORDS[Math.floor(Math.random()*WORDS.length)];
    const chars=word.split('');const shuffled=shuffle([...chars]);
    let placed=[];
    $('g3WText').textContent='ã‚‚ã˜ã‚’ ãªã‚‰ã¹ã¦ ã“ã¨ã°ã‚’ ã¤ãã‚ã†ï¼';
    const slots=$('g3WSlots');slots.textContent='';
    chars.forEach(()=>{const s=document.createElement('div');s.className='g3-wordSlot';slots.appendChild(s);});
    const pieces=$('g3WPieces');pieces.textContent='';
    shuffled.forEach((ch,i)=>{
      const p=document.createElement('button');p.className='g3-piece';p.textContent=ch;p.dataset.idx=String(i);
      p.addEventListener('click',()=>{
        if(p.classList.contains('used'))return;p.classList.add('used');
        placed.push(ch);const slotEls=slots.querySelectorAll('.g3-wordSlot');
        slotEls[placed.length-1].textContent=ch;slotEls[placed.length-1].classList.add('filled');
        if(placed.length===chars.length){
          const ok=placed.join('')===word;
          slotEls.forEach(s=>s.classList.add(ok?'ok':'ng'));
          if(ok){wScore++;$('g3WScore').textContent='â­ '+wScore+' ã‚‚ã‚“ ã›ã„ã‹ã„ï¼';showCeleb('ğŸ‰ ã™ã”ã„ï¼');playCorrectSound();speak('ã›ã„ã‹ã„ï¼'+word+'ï¼');}
          else{playWrongSound();speak('ãŠã—ã„ï¼ã“ãŸãˆã¯ '+word+' ã ã‚ˆ');}
          setTimeout(genWord,2000);
        }
      });
      pieces.appendChild(p);
    });
    speak(word+'ã‚’ ã¤ãã‚ã†ï¼');
  }

  // Stats
  function renderStats(){
    const grid=$('g3StatsGrid');grid.textContent='';
    curData.forEach(it=>{
      const cell=document.createElement('div');cell.className='g3-statCell';
      const ch=document.createElement('div');ch.className='ch';ch.textContent=it.h;cell.appendChild(ch);
      const rt=document.createElement('div');rt.className='rt';
      const rate=getRate(it.h);rt.textContent=rate>=0?rate+'%':'--';
      if(rate>=80)rt.style.color='var(--ok)';else if(rate>=50)rt.style.color='var(--ng)';else if(rate>=0)rt.style.color='var(--accent)';
      cell.appendChild(rt);grid.appendChild(cell);
    });
  }

  // Trace
  $('g3TraceBtn').addEventListener('click',()=>{
    const overlay=$('g3TraceOverlay');overlay.classList.add('show');
    const canvas=$('g3TraceCanvas');const ctx=canvas.getContext('2d');
    const size=Math.min(320,window.innerWidth-40);canvas.width=size;canvas.height=size;
    ctx.clearRect(0,0,size,size);
    // Draw guide character
    ctx.fillStyle='rgba(0,0,0,0.08)';ctx.font='bold '+Math.floor(size*0.7)+'px "Zen Maru Gothic",sans-serif';ctx.textAlign='center';ctx.textBaseline='middle';
    ctx.fillText(curData[idx].h,size/2,size/2);
    // Drawing
    let drawing=false;
    ctx.strokeStyle='#ff4d6d';ctx.lineWidth=6;ctx.lineCap='round';ctx.lineJoin='round';
    function getPos(e){const r=canvas.getBoundingClientRect();const t=e.touches?e.touches[0]:e;return{x:t.clientX-r.left,y:t.clientY-r.top};}
    function down(e){e.preventDefault();drawing=true;const p=getPos(e);ctx.beginPath();ctx.moveTo(p.x,p.y);}
    function move(e){if(!drawing)return;e.preventDefault();const p=getPos(e);ctx.lineTo(p.x,p.y);ctx.stroke();}
    function up(){drawing=false;}
    canvas.onmousedown=down;canvas.onmousemove=move;canvas.onmouseup=up;canvas.onmouseleave=up;
    canvas.ontouchstart=down;canvas.ontouchmove=move;canvas.ontouchend=up;
  });
  $('g3TraceClose').addEventListener('click',()=>{$('g3TraceOverlay').classList.remove('show');});

  function showCeleb(text){const el=$('g3Celeb');const t=document.createElement('div');t.className='g3-celebText';t.textContent=text;el.textContent='';el.appendChild(t);setTimeout(()=>{el.textContent='';},1200);}

  window.g3Init=function(){if(!initialized){initialized=true;updateCard();speakCard();}};
})();

// ============================================================
//  Game4: ãªãã”ãˆã‚ã¦ã‚²ãƒ¼ãƒ 
// ============================================================
(function(){
  const SOUND_ANIMALS=[
    {key:"inu",name:"ã„ã¬",soundFile:"éŸ³å£°/inu.mp3",cry:"ãƒ¯ãƒ³ãƒ¯ãƒ³ï¼"},
    {key:"neko",name:"ã­ã“",soundFile:"éŸ³å£°/neko.mp3",cry:"ãƒ‹ãƒ£ãƒ¼ï¼"},
    {key:"zou",name:"ãã†",soundFile:"éŸ³å£°/zou.mp3",cry:"ãƒ‘ã‚ªãƒ¼ãƒ³ï¼"},
    {key:"raion",name:"ã‚‰ã„ãŠã‚“",soundFile:"éŸ³å£°/raion.mp3",cry:"ã‚¬ã‚ªãƒ¼ï¼"},
    {key:"buta",name:"ã¶ãŸ",soundFile:"éŸ³å£°/buta.mp3",cry:"ãƒ–ãƒ¼ãƒ–ãƒ¼ï¼"},
    {key:"hiyoko",name:"ã²ã‚ˆã“",soundFile:"éŸ³å£°/hiyoko.mp3",cry:"ã´ã‚ˆã´ã‚ˆï¼"},
    {key:"karasu",name:"ã‹ã‚‰ã™",soundFile:"éŸ³å£°/karasu.mp3",cry:"ã‚«ãƒ¼ã‚«ãƒ¼ï¼"},
    {key:"niwatori",name:"ã«ã‚ã¨ã‚Š",soundFile:"éŸ³å£°/niwatori.mp3",cry:"ã‚³ã‚±ã‚³ãƒƒã‚³ãƒ¼ï¼"},
    {key:"ookami",name:"ãŠãŠã‹ã¿",soundFile:"éŸ³å£°/ookami.mp3",cry:"ã‚¢ã‚ªãƒ¼ãƒ³ï¼"},
    {key:"uma",name:"ã†ã¾",soundFile:"éŸ³å£°/uma.mp3",cry:"ãƒ’ãƒ’ãƒ¼ãƒ³ï¼"},
    {key:"yagi",name:"ã‚„ã",soundFile:"éŸ³å£°/yagi.mp3",cry:"ãƒ¡ã‚§ãƒ¼ï¼"},
    {key:"ushi",name:"ã†ã—",soundFile:"éŸ³å£°/ushi.mp3",cry:"ãƒ¢ãƒ¼ï¼"},
    {key:"pengin",name:"ãºã‚“ãã‚“",soundFile:"éŸ³å£°/ãƒšãƒ³ã‚®ãƒ³ã®é³´ãå£°.mp3",cry:"ãºãºãºã£ï¼"},
    {key:"hitsuji",name:"ã²ã¤ã˜",soundFile:"éŸ³å£°/ãƒ’ãƒ„ã‚¸ã®é³´ãå£°.mp3",cry:"ãƒ¡ã‚§ãƒ¼ï¼"},
  ];
  const ROUNDS=5;
  const $=id=>document.getElementById(id);
  let score=0,round=0,current=null,locked=false,usedKeys=[],cryAudio=null,g4Timer=null;

  function playCry4(animal){
    if(cryAudio){cryAudio.pause();cryAudio=null;}
    const btn=$('g4Speaker');btn.classList.add('playing');
    if(animal.soundFile){
      cryAudio=new Audio(animal.soundFile);cryAudio.volume=1.0;
      cryAudio.onended=()=>btn.classList.remove('playing');
      cryAudio.onerror=()=>{btn.classList.remove('playing');speak(animal.cry);};
      cryAudio.play().catch(()=>{btn.classList.remove('playing');speak(animal.cry);});
    }else{speak(animal.cry,()=>btn.classList.remove('playing'));}
  }

  function nextRound4(){
    if(round>=ROUNDS){showResult4();return;}
    locked=false;
    let available=SOUND_ANIMALS.filter(a=>!usedKeys.includes(a.key));
    if(!available.length){usedKeys=[];available=[...SOUND_ANIMALS];}
    current=available[Math.floor(Math.random()*available.length)];
    usedKeys.push(current.key);round++;
    $('g4Badge').textContent='ğŸ¾ '+round+'/'+ROUNDS+'ã€€â­ '+score;
    const others=shuffle(SOUND_ANIMALS.filter(a=>a.key!==current.key)).slice(0,3);
    const choices=shuffle([current,...others]);
    const grid=$('g4Grid');grid.textContent='';
    choices.forEach(item=>{
      const btn=document.createElement('button');btn.className='g4-choice';btn.type='button';
      btn.appendChild(mkImg(item.key));
      const lab=document.createElement('div');lab.textContent=item.name;btn.appendChild(lab);
      btn.addEventListener('click',()=>onAnswer4(item,btn));
      grid.appendChild(btn);
    });
    setTimeout(()=>playCry4(current),300);
  }

  $('g4Speaker').addEventListener('click',()=>{if(current&&!locked)playCry4(current);});

  function onAnswer4(item,btnEl){
    if(locked)return;locked=true;
    const ok=item.key===current.key;
    document.querySelectorAll('#g4Grid .g4-choice').forEach(b=>{
      const label=b.querySelector('div').textContent;
      if(label===current.name)b.classList.add('correct');
      else if(b===btnEl&&!ok)b.classList.add('wrong');
    });
    if(ok){score++;playCorrectSound();speak('ã›ã„ã‹ã„ï¼ '+current.name+'ï¼');launchConfetti();}
    else{playWrongSound();speak('ãŠã—ã„ï¼ã“ãŸãˆã¯ '+current.name+' ã ã‚ˆï¼');}
    g4Timer=setTimeout(nextRound4,ok?1800:3000);
  }

  function showResult4(){
    showScreen('g4ResultScreen');
    const pct=Math.round(score/ROUNDS*100);
    let medal;
    if(score===ROUNDS)medal='ğŸ‘‘';else if(pct>=80)medal='ğŸ¥‡';else if(pct>=60)medal='ğŸ¥ˆ';else if(pct>=40)medal='ğŸ¥‰';else medal='ğŸ’ª';
    $('g4Medal').textContent=medal;
    $('g4Score').textContent=score+' / '+ROUNDS;
    $('g4Stars').textContent='â­'.repeat(score)+'â˜†'.repeat(ROUNDS-score);
    $('g4Sub').textContent=score===ROUNDS?'ãƒ‘ãƒ¼ãƒ•ã‚§ã‚¯ãƒˆï¼ï¼':pct>=80?'ã™ã°ã‚‰ã—ã„ï¼':pct>=60?'ãŒã‚“ã°ã£ãŸã­ï¼':pct>=40?'ãŠã—ã„ï¼':'ã¤ãã¯ ãŒã‚“ã°ã‚ã†ï¼';
    if(score===ROUNDS){launchConfetti();speak('ãƒ‘ãƒ¼ãƒ•ã‚§ã‚¯ãƒˆï¼ã™ã”ã„ã­ï¼');}
    else speak(score+'ã‚‚ã‚“ ã›ã„ã‹ã„ï¼');
  }

  $('g4RetryBtn').addEventListener('click',()=>{showScreen('g4Screen');window.g4Init();});
  $('g4HomeBtn').addEventListener('click',goHome);

  window.g4Init=function(){if(g4Timer)clearTimeout(g4Timer);g4Timer=null;score=0;round=0;locked=false;usedKeys=[];nextRound4();};
  window.g4Stop=function(){if(cryAudio){cryAudio.pause();cryAudio=null;}if(g4Timer)clearTimeout(g4Timer);g4Timer=null;};
})();

// ============================================================
//  Game5: ã‚ãã‚Šã‚ã‚ã›
// ============================================================
(function(){
  const ALL_ANIMALS=[
    {key:"inu",name:"ã„ã¬",soundFile:"éŸ³å£°/inu.mp3",cry:"ãƒ¯ãƒ³ãƒ¯ãƒ³ï¼"},
    {key:"neko",name:"ã­ã“",soundFile:"éŸ³å£°/neko.mp3",cry:"ãƒ‹ãƒ£ãƒ¼ï¼"},
    {key:"zou",name:"ãã†",soundFile:"éŸ³å£°/zou.mp3",cry:"ãƒ‘ã‚ªãƒ¼ãƒ³ï¼"},
    {key:"raion",name:"ã‚‰ã„ãŠã‚“",soundFile:"éŸ³å£°/raion.mp3",cry:"ã‚¬ã‚ªãƒ¼ï¼"},
    {key:"buta",name:"ã¶ãŸ",soundFile:"éŸ³å£°/buta.mp3",cry:"ãƒ–ãƒ¼ãƒ–ãƒ¼ï¼"},
    {key:"hiyoko",name:"ã²ã‚ˆã“",soundFile:"éŸ³å£°/hiyoko.mp3",cry:"ã´ã‚ˆã´ã‚ˆï¼"},
    {key:"karasu",name:"ã‹ã‚‰ã™",soundFile:"éŸ³å£°/karasu.mp3",cry:"ã‚«ãƒ¼ã‚«ãƒ¼ï¼"},
    {key:"niwatori",name:"ã«ã‚ã¨ã‚Š",soundFile:"éŸ³å£°/niwatori.mp3",cry:"ã‚³ã‚±ã‚³ãƒƒã‚³ãƒ¼ï¼"},
    {key:"ookami",name:"ãŠãŠã‹ã¿",soundFile:"éŸ³å£°/ookami.mp3",cry:"ã‚¢ã‚ªãƒ¼ãƒ³ï¼"},
    {key:"uma",name:"ã†ã¾",soundFile:"éŸ³å£°/uma.mp3",cry:"ãƒ’ãƒ’ãƒ¼ãƒ³ï¼"},
    {key:"yagi",name:"ã‚„ã",soundFile:"éŸ³å£°/yagi.mp3",cry:"ãƒ¡ã‚§ãƒ¼ï¼"},
    {key:"ushi",name:"ã†ã—",soundFile:"éŸ³å£°/ushi.mp3",cry:"ãƒ¢ãƒ¼ï¼"},
    {key:"kuma",name:"ãã¾",soundFile:null,cry:"ã‚¬ã‚ªãƒ¼ï¼"},
    {key:"kirin",name:"ãã‚Šã‚“",soundFile:null,cry:"ã‚‚ãã‚‚ã"},
    {key:"hitsuji",name:"ã²ã¤ã˜",soundFile:"éŸ³å£°/ãƒ’ãƒ„ã‚¸ã®é³´ãå£°.mp3",cry:"ãƒ¡ã‚§ãƒ¼ï¼"},
    {key:"pengin",name:"ãºã‚“ãã‚“",soundFile:"éŸ³å£°/ãƒšãƒ³ã‚®ãƒ³ã®é³´ãå£°.mp3",cry:"ãºãºãºã£ï¼"},
    {key:"koara",name:"ã‚³ã‚¢ãƒ©",soundFile:null,cry:"ã™ã‚„ã™ã‚„"},
  ];
  const $=id=>document.getElementById(id);
  let cards=[],flipped=[],matched=0,total=0,locked=false,difficulty='lv1',g5FlipTimer=null,g5DoneTimer=null;

  function initG5(diff){
    difficulty=diff;
    const pairs=diff==='lv1'?4:diff==='lv2'?6:8;
    total=pairs;matched=0;flipped=[];locked=false;
    if(g5FlipTimer)clearTimeout(g5FlipTimer);g5FlipTimer=null;
    if(g5DoneTimer)clearTimeout(g5DoneTimer);g5DoneTimer=null;
    $('g5Complete').style.display='none';
    const pool=shuffle([...ALL_ANIMALS]).slice(0,pairs);
    const deck=shuffle([...pool,...pool].map((a,i)=>({...a,uid:i})));
    cards=deck;
    $('g5Badge').textContent='ãƒšã‚¢: 0 / '+pairs;
    const grid=$('g5Grid');
    grid.className='g5-grid';
    grid.textContent='';
    deck.forEach((a,i)=>{
      const card=document.createElement('div');card.className='g5-card';card.dataset.idx=String(i);
      const inner=document.createElement('div');inner.className='g5-inner';
      const front=document.createElement('div');front.className='g5-front';front.textContent='ğŸ¾';
      const back=document.createElement('div');back.className='g5-back';back.appendChild(mkImg(a.key));
      inner.appendChild(front);inner.appendChild(back);card.appendChild(inner);
      card.addEventListener('click',()=>flipCard(i,card));
      grid.appendChild(card);
    });
  }

  function flipCard(idx,cardEl){
    if(locked)return;
    if(cardEl.classList.contains('flipped')||cardEl.classList.contains('matched'))return;
    cardEl.classList.add('flipped');
    flipped.push({idx,cardEl,animal:cards[idx]});
    if(flipped.length===2){
      locked=true;
      const [a,b]=flipped;
      if(a.animal.key===b.animal.key){
        matched++;
        $('g5Badge').textContent='ãƒšã‚¢: '+matched+' / '+total;
        a.cardEl.classList.add('matched');b.cardEl.classList.add('matched');
        playCry(a.animal,null);
        playCorrectSound();
        flipped=[];locked=false;
        if(matched===total){
          g5DoneTimer=setTimeout(()=>{
            launchConfetti();
            speak('ã‚„ã£ãŸãƒ¼ï¼ãœã‚“ã¶ ãã‚ã£ãŸã‚ˆï¼');
            $('g5Complete').style.display='block';
          },400);
        }
      }else{
        g5FlipTimer=setTimeout(()=>{
          a.cardEl.classList.remove('flipped');b.cardEl.classList.remove('flipped');
          flipped=[];locked=false;
        },1000);
      }
    }
  }

  function setG5Active(id){['g5Lv1','g5Lv2','g5Lv3'].forEach(i=>$(i).classList.toggle('active',i===id));}
  $('g5Lv1').addEventListener('click',()=>{setG5Active('g5Lv1');initG5('lv1');});
  $('g5Lv2').addEventListener('click',()=>{setG5Active('g5Lv2');initG5('lv2');});
  $('g5Lv3').addEventListener('click',()=>{setG5Active('g5Lv3');initG5('lv3');});
  $('g5RetryBtn').addEventListener('click',()=>{$('g5Complete').style.display='none';initG5(difficulty);});
  $('g5HomeBtn').addEventListener('click',goHome);

  window.g5Init=function(){setG5Active('g5Lv1');initG5('lv1');};
  window.g5Stop=function(){if(g5FlipTimer)clearTimeout(g5FlipTimer);g5FlipTimer=null;if(g5DoneTimer)clearTimeout(g5DoneTimer);g5DoneTimer=null;};
})();

// ============================================================
//  Game6: ãŠãŠãã•ãã‚‰ã¹
// ============================================================
(function(){
  const SIZE={hiyoko:1,karasu:2,niwatori:3,neko:3,inu:4,yagi:5,hitsuji:5,koara:4,pengin:4,ookami:6,buta:7,raion:7,ushi:8,uma:8,kuma:8,kirin:9,zou:10};
  const ANIMALS=[
    {key:"inu",name:"ã„ã¬"},{key:"neko",name:"ã­ã“"},{key:"kuma",name:"ãã¾"},{key:"zou",name:"ãã†"},
    {key:"raion",name:"ã‚‰ã„ãŠã‚“"},{key:"pengin",name:"ãºã‚“ãã‚“"},{key:"kirin",name:"ãã‚Šã‚“"},{key:"hitsuji",name:"ã²ã¤ã˜"},
    {key:"buta",name:"ã¶ãŸ"},{key:"koara",name:"ã‚³ã‚¢ãƒ©"},{key:"hiyoko",name:"ã²ã‚ˆã“"},{key:"karasu",name:"ã‹ã‚‰ã™"},
    {key:"niwatori",name:"ã«ã‚ã¨ã‚Š"},{key:"ookami",name:"ãŠãŠã‹ã¿"},{key:"uma",name:"ã†ã¾"},{key:"yagi",name:"ã‚„ã"},{key:"ushi",name:"ã†ã—"},
  ];
  const ROUNDS=10;
  const $=id=>document.getElementById(id);
  let score=0,round=0,locked=false,pairs=[],g6Timer=null;

  function buildPairs(){
    const all=[];
    for(let i=0;i<ANIMALS.length;i++)for(let j=i+1;j<ANIMALS.length;j++){
      const a=ANIMALS[i],b=ANIMALS[j];
      if(Math.abs(SIZE[a.key]-SIZE[b.key])>=2)all.push([a,b]);
    }
    return shuffle(all).slice(0,ROUNDS);
  }

  function nextRound6(){
    if(round>=ROUNDS){showResult6();return;}
    locked=false;
    const [a,b]=pairs[round];round++;
    $('g6Badge').textContent='ğŸ¾ '+round+'/'+ROUNDS+'ã€€â­ '+score;
    const pair=$('g6Pair');pair.textContent='';
    [a,b].forEach(animal=>{
      const btn=document.createElement('button');btn.className='g6-animal';btn.type='button';
      const img=mkImg(animal.key);
      btn.appendChild(img);
      const nm=document.createElement('div');nm.className='g6-name';nm.textContent=animal.name;btn.appendChild(nm);
      btn.addEventListener('click',()=>onAnswer6(animal,btn,a,b));
      pair.appendChild(btn);
    });
    speak('ã©ã£ã¡ãŒ ãŠãŠãã„ï¼Ÿ');
  }

  function onAnswer6(chosen,btnEl,a,b){
    if(locked)return;locked=true;
    const correctAnimal=SIZE[a.key]>=SIZE[b.key]?a:b;
    const ok=chosen.key===correctAnimal.key;
    document.querySelectorAll('#g6Pair .g6-animal').forEach(btn=>{
      const name=btn.querySelector('.g6-name').textContent;
      if(name===correctAnimal.name)btn.classList.add('correct');
      else if(btn===btnEl&&!ok)btn.classList.add('wrong');
    });
    if(ok){score++;playCorrectSound();speak('ã›ã„ã‹ã„ï¼ '+correctAnimal.name+' ã® ã»ã†ãŒ ãŠãŠãã„ã‚ˆï¼');}
    else{playWrongSound();speak('ãŠã—ã„ï¼ '+correctAnimal.name+' ã® ã»ã†ãŒ ãŠãŠãã„ã‚ˆï¼');}
    g6Timer=setTimeout(nextRound6,ok?1800:3500);
  }

  function showResult6(){
    showScreen('g6ResultScreen');
    const pct=Math.round(score/ROUNDS*100);
    let medal;
    if(score===ROUNDS)medal='ğŸ‘‘';else if(pct>=80)medal='ğŸ¥‡';else if(pct>=60)medal='ğŸ¥ˆ';else if(pct>=40)medal='ğŸ¥‰';else medal='ğŸ’ª';
    $('g6Medal').textContent=medal;
    $('g6Score').textContent=score+' / '+ROUNDS;
    $('g6Stars').textContent='â­'.repeat(score)+'â˜†'.repeat(ROUNDS-score);
    $('g6Sub').textContent=score===ROUNDS?'ãƒ‘ãƒ¼ãƒ•ã‚§ã‚¯ãƒˆï¼ï¼':pct>=80?'ã™ã°ã‚‰ã—ã„ï¼':pct>=60?'ãŒã‚“ã°ã£ãŸã­ï¼':pct>=40?'ãŠã—ã„ï¼':'ã¤ãã¯ ãŒã‚“ã°ã‚ã†ï¼';
    if(score===ROUNDS){launchConfetti();speak('ãƒ‘ãƒ¼ãƒ•ã‚§ã‚¯ãƒˆï¼ã™ã”ã„ã­ï¼');}
    else speak(score+'ã‚‚ã‚“ ã›ã„ã‹ã„ï¼');
  }

  $('g6RetryBtn').addEventListener('click',()=>{showScreen('g6Screen');window.g6Init();});
  $('g6HomeBtn').addEventListener('click',goHome);

  window.g6Init=function(){if(g6Timer)clearTimeout(g6Timer);g6Timer=null;score=0;round=0;locked=false;pairs=buildPairs();nextRound6();};
  window.g6Stop=function(){if(g6Timer)clearTimeout(g6Timer);g6Timer=null;};
})();

// ============================================================
//  Game7: ã“ã¨ã°ã‹ã‚“ã›ã„
// ============================================================
(function(){
  const ANIMALS=[
    {key:"inu",name:"ã„ã¬"},{key:"neko",name:"ã­ã“"},{key:"kuma",name:"ãã¾"},{key:"zou",name:"ãã†"},
    {key:"raion",name:"ã‚‰ã„ãŠã‚“"},{key:"pengin",name:"ãºã‚“ãã‚“"},{key:"kirin",name:"ãã‚Šã‚“"},{key:"hitsuji",name:"ã²ã¤ã˜"},
    {key:"buta",name:"ã¶ãŸ"},{key:"hiyoko",name:"ã²ã‚ˆã“"},{key:"karasu",name:"ã‹ã‚‰ã™"},
    {key:"niwatori",name:"ã«ã‚ã¨ã‚Š"},{key:"ookami",name:"ãŠãŠã‹ã¿"},{key:"uma",name:"ã†ã¾"},{key:"yagi",name:"ã‚„ã"},{key:"ushi",name:"ã†ã—"},
  ];
  // All unique hiragana chars that appear in animal names (pool for distractors)
  const ANIMAL_CHARS=[...new Set(ANIMALS.flatMap(a=>a.name.split('')))];
  const ROUNDS=10;
  const $=id=>document.getElementById(id);
  let score=0,round=0,locked=false,difficulty='easy',usedKeys=[],current=null,g7Timer=null;

  function nextRound7(){
    if(round>=ROUNDS){showResult7();return;}
    locked=false;
    let available=ANIMALS.filter(a=>!usedKeys.includes(a.key));
    if(!available.length){usedKeys=[];available=[...ANIMALS];}
    current=available[Math.floor(Math.random()*available.length)];
    usedKeys.push(current.key);round++;
    $('g7Badge').textContent='ğŸ¾ '+round+'/'+ROUNDS+'ã€€â­ '+score;
    // Animal image
    const icon=$('g7Icon');icon.textContent='';icon.appendChild(mkImg(current.key));
    // Blank position
    const name=current.name;
    const blankIdx=difficulty==='easy'?0:name.length-1;
    const correct=name[blankIdx];
    // Render word with blank
    const wordEl=$('g7Word');wordEl.textContent='';
    for(let i=0;i<name.length;i++){
      if(i===blankIdx){
        const blank=document.createElement('span');blank.className='g7-blank';blank.textContent='ï¼¿';wordEl.appendChild(blank);
      }else{
        wordEl.appendChild(document.createTextNode(name[i]));
      }
    }
    // Choices: correct + 3 distractors from animal chars pool
    const pool=ANIMAL_CHARS.filter(c=>c!==correct);
    const distractors=shuffle(pool).slice(0,3);
    const allChoices=shuffle([correct,...distractors]);
    const choicesEl=$('g7Choices');choicesEl.textContent='';
    allChoices.forEach(ch=>{
      const btn=document.createElement('button');btn.className='g7-choice';btn.type='button';btn.textContent=ch;
      btn.addEventListener('click',()=>onAnswer7(ch,btn,correct));
      choicesEl.appendChild(btn);
    });
    speak(current.name+'ã® '+(difficulty==='easy'?'ã•ã„ã—ã‚‡':'ã•ã„ã”')+'ã® ã‚‚ã˜ã¯ï¼Ÿ');
  }

  function onAnswer7(chosen,btnEl,correct){
    if(locked)return;locked=true;
    const ok=chosen===correct;
    document.querySelectorAll('#g7Choices .g7-choice').forEach(b=>{
      if(b.textContent===correct)b.classList.add('correct');
      else if(b===btnEl&&!ok)b.classList.add('wrong');
    });
    const blank=$('g7Word').querySelector('.g7-blank');
    if(blank){blank.textContent=correct;blank.style.borderStyle='solid';blank.style.color='var(--ok)';}
    if(ok){score++;playCorrectSound();speak('ã›ã„ã‹ã„ï¼ '+current.name+'ï¼');}
    else{playWrongSound();speak('ãŠã—ã„ï¼ã€Œ'+correct+'ã€ã ã‚ˆï¼');}
    g7Timer=setTimeout(nextRound7,ok?1800:3000);
  }

  function showResult7(){
    showScreen('g7ResultScreen');
    const pct=Math.round(score/ROUNDS*100);
    let medal;
    if(score===ROUNDS)medal='ğŸ‘‘';else if(pct>=80)medal='ğŸ¥‡';else if(pct>=60)medal='ğŸ¥ˆ';else if(pct>=40)medal='ğŸ¥‰';else medal='ğŸ’ª';
    $('g7Medal').textContent=medal;
    $('g7Score').textContent=score+' / '+ROUNDS;
    $('g7Stars').textContent='â­'.repeat(score)+'â˜†'.repeat(ROUNDS-score);
    $('g7Sub').textContent=score===ROUNDS?'ãƒ‘ãƒ¼ãƒ•ã‚§ã‚¯ãƒˆï¼ï¼':pct>=80?'ã™ã°ã‚‰ã—ã„ï¼':pct>=60?'ãŒã‚“ã°ã£ãŸã­ï¼':pct>=40?'ãŠã—ã„ï¼':'ã¤ãã¯ ãŒã‚“ã°ã‚ã†ï¼';
    if(score===ROUNDS){launchConfetti();speak('ãƒ‘ãƒ¼ãƒ•ã‚§ã‚¯ãƒˆï¼ã™ã”ã„ã­ï¼');}
    else speak(score+'ã‚‚ã‚“ ã›ã„ã‹ã„ï¼');
  }

  $('g7Easy').addEventListener('click',()=>{
    if(g7Timer)clearTimeout(g7Timer);g7Timer=null;
    difficulty='easy';$('g7Easy').classList.add('active');$('g7Normal').classList.remove('active');
    score=0;round=0;locked=false;usedKeys=[];nextRound7();
  });
  $('g7Normal').addEventListener('click',()=>{
    if(g7Timer)clearTimeout(g7Timer);g7Timer=null;
    difficulty='normal';$('g7Normal').classList.add('active');$('g7Easy').classList.remove('active');
    score=0;round=0;locked=false;usedKeys=[];nextRound7();
  });
  $('g7RetryBtn').addEventListener('click',()=>{showScreen('g7Screen');window.g7Init();});
  $('g7HomeBtn').addEventListener('click',goHome);

  window.g7Init=function(){
    if(g7Timer)clearTimeout(g7Timer);g7Timer=null;
    score=0;round=0;locked=false;usedKeys=[];difficulty='easy';
    $('g7Easy').classList.add('active');$('g7Normal').classList.remove('active');
    nextRound7();
  };
  window.g7Stop=function(){if(g7Timer)clearTimeout(g7Timer);g7Timer=null;};
})();

// ============================================================
// Game8: ã©ã†ã¶ã¤ãƒ”ã‚¢ãƒ
// ============================================================
(function(){
  var NOTES=[
    {note:'ãƒ‰',  freq:261.63,key:'inu',   name:'ã„ã¬',   sound:'éŸ³å£°/inu.mp3'},
    {note:'ãƒ¬',  freq:293.66,key:'neko',  name:'ã­ã“',   sound:'éŸ³å£°/neko.mp3'},
    {note:'ãƒŸ',  freq:329.63,key:'hiyoko',name:'ã²ã‚ˆã“', sound:'éŸ³å£°/hiyoko.mp3'},
    {note:'ãƒ•ã‚¡',freq:349.23,key:'buta',  name:'ã¶ãŸ',   sound:'éŸ³å£°/buta.mp3'},
    {note:'ã‚½',  freq:392.00,key:'raion', name:'ã‚‰ã„ãŠã‚“',sound:'éŸ³å£°/raion.mp3'},
    {note:'ãƒ©',  freq:440.00,key:'pengin',name:'ãºã‚“ãã‚“',sound:'éŸ³å£°/ãƒšãƒ³ã‚®ãƒ³ã®é³´ãå£°.mp3'},
    {note:'ã‚·',  freq:493.88,key:'ushi',  name:'ã†ã—',   sound:'éŸ³å£°/ushi.mp3'},
    {note:'é«˜ãƒ‰',freq:523.25,key:'zou',   name:'ãã†',   sound:'éŸ³å£°/zou.mp3'},
  ];
  var LEVEL_COUNT={easy:3,normal:5,hard:8};
  var TOTAL=8;
  // ãã‚‰ãã‚‰ã¼ã—: [noteIdx, durationMs]  (0=ãƒ‰,1=ãƒ¬,2=ãƒŸ,3=ãƒ•ã‚¡,4=ã‚½,5=ãƒ©,6=ã‚·,7=é«˜ãƒ‰)
  var MELODIES=[
    [[0,400],[0,400],[4,400],[4,400],[5,400],[5,400],[4,800],
     [3,400],[3,400],[2,400],[2,400],[1,400],[1,400],[0,800],
     [4,400],[4,400],[3,400],[3,400],[2,400],[2,400],[1,800],
     [4,400],[4,400],[3,400],[3,400],[2,400],[2,400],[1,800],
     [0,400],[0,400],[4,400],[4,400],[5,400],[5,400],[4,800],
     [3,400],[3,400],[2,400],[2,400],[1,400],[1,400],[0,800]],
    [[0,400],[2,400],[4,400],[4,800],[2,400],[0,400],[2,400],[4,400],[4,800],[4,800],
     [5,400],[4,400],[3,400],[3,400],[2,400],[1,400],[0,400],[2,400],[4,400],[4,800],[4,800],
     [4,400],[3,400],[2,400],[2,800],[1,400],[2,400],[3,400],[3,800],
     [0,400],[2,400],[4,400],[4,800],[2,400],[0,400],[2,400],[4,400],[4,800],[4,800]]
  ];
  var $=function(id){return document.getElementById(id);};
  var mode='free',level='easy';
  var score=0,round=0,locked=false,usedIdx=[],currentNote=null,g8Timer=null;
  var keyEls=[];
  var rensouIdx=0;
  var melodyTimers=[];

  function playNote(freq,dur){
    dur=dur||0.5;
    try{
      var c=getAudioCtx();
      var o=c.createOscillator(),g=c.createGain();
      o.type='triangle';o.frequency.value=freq;
      g.gain.setValueAtTime(0.2,c.currentTime);
      g.gain.exponentialRampToValueAtTime(0.01,c.currentTime+dur);
      o.connect(g);g.connect(c.destination);
      o.start(c.currentTime);o.stop(c.currentTime+dur);
    }catch(e){}
  }

  function buildKeyboard(){
    var kb=$('g8Keyboard');kb.textContent='';keyEls=[];
    var count=LEVEL_COUNT[level];
    NOTES.forEach(function(n,idx){
      var el=document.createElement('div');
      el.className='g8-key'+(idx>=count?' inactive':'');
      el.appendChild(mkImg(n.key));
      var noteEl=document.createElement('div');noteEl.className='g8-note';noteEl.textContent=n.note;el.appendChild(noteEl);
      var animalEl=document.createElement('div');animalEl.className='g8-animal';animalEl.textContent=n.name;el.appendChild(animalEl);
      (function(nn,eel,ii){el.addEventListener('click',function(){onKeyPress(nn,eel,ii);});})(n,el,idx);
      kb.appendChild(el);keyEls.push(el);
    });
  }

  function flashKey(el,cls,ms){
    ms=ms||500;
    el.classList.add(cls);
    setTimeout(function(){el.classList.remove(cls);},ms);
  }

  function danceKey(el){
    el.classList.remove('dancing');
    void el.offsetWidth;
    el.classList.add('dancing');
    setTimeout(function(){el.classList.remove('dancing');},700);
  }

  function stopMelody(){
    melodyTimers.forEach(function(id){clearTimeout(id);});
    melodyTimers=[];
    keyEls.forEach(function(k){k.classList.remove('melody-active');});
  }

  function showGuide(idx){
    keyEls.forEach(function(k){k.classList.remove('guide');});
    var count=LEVEL_COUNT[level];
    if(idx<count&&keyEls[idx]){
      keyEls[idx].classList.add('guide');
      playNote(NOTES[idx].freq,0.4);
    }
  }

  function startRensou(){
    var count=LEVEL_COUNT[level];
    if(count<1)return;
    mode='rensou';
    rensouIdx=0;
    stopMelody();
    $('g8StartQuizBtn').style.display='none';
    $('g8RensouBtn').style.display='none';
    $('g8FreeTip').style.display='none';
    $('g8MelodySection').style.display='none';
    $('g8LvSelect').style.display='none';
    showGuide(rensouIdx);
    speak('ã²ã‹ã£ãŸ ã‘ã‚“ã°ã‚“ã‚’ ã˜ã‚…ã‚“ã°ã‚“ã« ãŠã—ã¦ã­ï¼');
  }

  function playMelody(melodyIdx){
    stopMelody();
    var mel=MELODIES[melodyIdx];
    if(!mel)return;
    var elapsed=0;
    mel.forEach(function(step){
      var noteIdx=step[0];
      var dur=step[1];
      var t1=setTimeout(function(){
        var count=LEVEL_COUNT[level];
        if(noteIdx<count&&keyEls[noteIdx]){
          keyEls[noteIdx].classList.add('melody-active');
          playNote(NOTES[noteIdx].freq,dur/1000);
          var t2=setTimeout(function(){
            if(keyEls[noteIdx])keyEls[noteIdx].classList.remove('melody-active');
          },dur-50);
          melodyTimers.push(t2);
        }
      },elapsed);
      melodyTimers.push(t1);
      elapsed+=dur;
    });
  }

  function onKeyPress(n,keyEl,idx){
    var count=LEVEL_COUNT[level];
    if(idx>=count)return;
    if(mode==='free'){
      playNote(n.freq);
      flashKey(keyEl,'correct');
      danceKey(keyEl);
      setTimeout(function(){try{new Audio(n.sound).play();}catch(e){}},400);
    }else if(mode==='rensou'){
      if(idx!==rensouIdx)return;
      keyEls[rensouIdx].classList.remove('guide');
      flashKey(keyEl,'correct');
      danceKey(keyEl);
      playNote(n.freq);
      rensouIdx++;
      if(rensouIdx>=count){
        launchConfetti();
        speak('ã™ã”ã„ï¼ãœã‚“ã¶ ã§ããŸã­ï¼');
        g8Timer=setTimeout(function(){
          mode='free';
          keyEls.forEach(function(k){k.classList.remove('guide');});
          $('g8StartQuizBtn').style.display='';
          $('g8RensouBtn').style.display='';
          $('g8FreeTip').style.display='';
          $('g8MelodySection').style.display='flex';
          $('g8LvSelect').style.display='';
        },2000);
      }else{
        g8Timer=setTimeout(function(){showGuide(rensouIdx);},400);
      }
    }else{
      if(locked)return;
      locked=true;
      var ok=(n.key===currentNote.key);
      if(ok){
        flashKey(keyEl,'correct');
        danceKey(keyEl);
        playCorrectSound();
        speak('ã›ã„ã‹ã„ï¼'+currentNote.note+' ã ã‚ˆï¼');
        score++;
        if(g8Timer)clearTimeout(g8Timer);
        g8Timer=setTimeout(nextRound8,1800);
      }else{
        keyEl.classList.add('wrong');
        var correctIdx=NOTES.findIndex(function(x){return x.key===currentNote.key;});
        if(correctIdx>=0)flashKey(keyEls[correctIdx],'correct',3200);
        playWrongSound();
        speak('ãŠã—ã„ï¼'+currentNote.note+' ã ã‚ˆï¼');
        if(g8Timer)clearTimeout(g8Timer);
        g8Timer=setTimeout(nextRound8,3200);
      }
    }
  }

  function nextRound8(){
    if(round>=TOTAL){showResult8();return;}
    locked=false;
    var count=LEVEL_COUNT[level];
    var avail=[];
    for(var i=0;i<count;i++){if(usedIdx.indexOf(i)<0)avail.push(i);}
    if(!avail.length){usedIdx=[];for(var j=0;j<count;j++)avail.push(j);}
    var pick=avail[Math.floor(Math.random()*avail.length)];
    usedIdx.push(pick);
    currentNote=NOTES[pick];
    round++;
    $('g8QuizLabel').textContent=currentNote.note+' ã‚’ ãŠã—ã¦ï¼';
    $('g8AgainBtn').style.display='';
    keyEls.forEach(function(k){k.classList.remove('correct','wrong');});
    speak(currentNote.note+' ã‚’ ãŠã—ã¦ï¼',function(){
      if(!locked){g8Timer=setTimeout(function(){playNote(currentNote.freq,0.8);},600);}
    });
  }

  function startQuiz(){
    mode='quiz';
    score=0;round=0;locked=false;usedIdx=[];
    stopMelody();
    $('g8StartQuizBtn').style.display='none';
    $('g8RensouBtn').style.display='none';
    $('g8FreeTip').style.display='none';
    $('g8MelodySection').style.display='none';
    $('g8AgainBtn').style.display='none';
    $('g8QuizLabel').style.display='';
    $('g8LvSelect').style.display='none';
    nextRound8();
  }

  function showResult8(){
    showScreen('g8ResultScreen');
    var pct=Math.round(score/TOTAL*100);
    var medal;
    if(score===TOTAL)medal='ğŸ‘‘';
    else if(pct>=80)medal='ğŸ¥‡';
    else if(pct>=60)medal='ğŸ¥ˆ';
    else if(pct>=40)medal='ğŸ¥‰';
    else medal='ğŸ’ª';
    $('g8Medal').textContent=medal;
    $('g8Score').textContent=score+' / '+TOTAL;
    $('g8Stars').textContent='â­'.repeat(score)+'â˜†'.repeat(TOTAL-score);
    $('g8Sub').textContent=score===TOTAL?'ãƒ‘ãƒ¼ãƒ•ã‚§ã‚¯ãƒˆï¼ï¼':pct>=80?'ã™ã°ã‚‰ã—ã„ï¼':pct>=60?'ãŒã‚“ã°ã£ãŸã­ï¼':pct>=40?'ãŠã—ã„ï¼':'ã¤ãã¯ ãŒã‚“ã°ã‚ã†ï¼';
    if(score===TOTAL){launchConfetti();speak('ãƒ‘ãƒ¼ãƒ•ã‚§ã‚¯ãƒˆï¼ã™ã”ã„ã­ï¼');}
    else speak(score+'ã‚‚ã‚“ ã›ã„ã‹ã„ï¼');
  }

  function setLevel(lv){
    level=lv;
    ['easy','normal','hard'].forEach(function(l){
      var id='g8Lv'+l.charAt(0).toUpperCase()+l.slice(1);
      $(id).classList.toggle('active',l===lv);
    });
    buildKeyboard();
  }

  $('g8LvEasy').addEventListener('click',function(){setLevel('easy');});
  $('g8LvNormal').addEventListener('click',function(){setLevel('normal');});
  $('g8LvHard').addEventListener('click',function(){setLevel('hard');});
  $('g8StartQuizBtn').addEventListener('click',startQuiz);
  $('g8RetryBtn').addEventListener('click',function(){showScreen('g8Screen');window.g8Init();});
  $('g8HomeBtn').addEventListener('click',goHome);
  $('g8AgainBtn').addEventListener('click',function(){
    speak(currentNote.note+' ã‚’ ãŠã—ã¦ï¼',function(){
      if(!locked){playNote(currentNote.freq,0.8);}
    });
  });
  $('g8RensouBtn').addEventListener('click',startRensou);
  document.querySelectorAll('.g8-melody-btn').forEach(function(btn){
    btn.addEventListener('click',function(){playMelody(Number(btn.dataset.melody));});
  });
  $('g8MelodyStopBtn').addEventListener('click',stopMelody);

  window.g8Init=function(){
    if(g8Timer){clearTimeout(g8Timer);g8Timer=null;}
    stopMelody();
    mode='free';score=0;round=0;locked=false;usedIdx=[];rensouIdx=0;
    keyEls.forEach(function(k){k.classList.remove('guide','dancing','melody-active');});
    $('g8StartQuizBtn').style.display='';
    $('g8RensouBtn').style.display='';
    $('g8FreeTip').style.display='';
    $('g8QuizLabel').style.display='none';
    $('g8AgainBtn').style.display='none';
    $('g8MelodySection').style.display='flex';
    $('g8LvSelect').style.display='';
    setLevel('easy');
  };
  window.g8Stop=function(){if(g8Timer){clearTimeout(g8Timer);g8Timer=null;}stopMelody();};
})();
</script>
</body>
</html>
